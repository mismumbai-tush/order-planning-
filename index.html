<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ginza Sales Planning System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#10a5e8',
                        'secondary': '#374151',
                        'accent': '#f59e0b',
                        'bg-light': '#f9fafb',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-bg-light min-h-screen font-sans">
    <div id="app" class="max-w-7xl mx-auto">
        <div class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50" id="initial-loading-screen">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary"></div>
            <p class="text-secondary ml-4">Initializing Application...</p>
        </div>
    </div>

    <script>
        // --- GLOBAL CONSTANTS & CONFIGURATION ---
        const COMPANY_LOGO_URL = 'https://www.ginzalimited.com/cdn/shop/files/Ginza_logo.jpg?v=1668509673&width=500';
        const COMPANY_NAME = 'Ginza Industries Limited';
        const BRANCHES = ['Ahmedabad', 'Bangalore', 'Delhi', 'Jaipur', 'Kolkata', 'Ludhiana', 'Mumbai', 'Surat', 'Ulhasnagar', 'Tirupur'];
        const UNITS = ['CKU', 'WARP', 'EMB', 'HOOK & EYE', 'ELASTIC', 'TLU', 'CROCHET', 'VAU', 'PRINTING', 'CUP'];
        const MAX_REMARK_LENGTH = 500;

        // Ã°Å¸Å¡Â¨ !!! CRITICAL STEP: REPLACE THESE WITH YOUR ACTUAL FIREBASE CONFIGURATION !!! Ã°Å¸Å¡Â¨
        const appId = 'order-target-planning'; // Use the actual Project ID or a custom app ID
        const firebaseConfig = {
            // Ã°Å¸â€ºâ€˜ REPLACE THIS with the apiKey from your Firebase Project Settings
            apiKey: "AIzaSyCgkd0TylEP3JJmvl5x5lC6qNH3Ce0t_us", 
            authDomain: "order-target-planning.firebaseapp.com",
            projectId: "order-target-planning",
            storageBucket: "order-target-planning.firebasestorage.app",
            messagingSenderId: "524933553639",
            appId: "1:524933553639:web:55c3d46598cdb9f3d0f142",
            measurementId: "G-DDVEX5XFMP" // Optional, can be removed if not using Analytics
        };

        let app, auth, db;
        let authReady = false;

        // --- APPLICATION STATE ---
        let state = {
            currentPage: 'Login', 
            currentUser: null,
            userId: null,
            userProfile: null, 
            plans: [], 
            filteredPlans: [], // For filter results
            dataLoaded: false, // Flag for auto-loading KPI on first data load
            actualDetails: null, 
            charts: {}, 
            modal: { isOpen: false, title: '', content: '' },
            loading: false,
            displayFormat: 'auto', // 'auto', 'K/M' or 'normal'

            newPlanFormData: { startDate: '', endDate: '' }, // Store form input values
            filters: {
                dashboard: { employee: '', branch: '', month: '', year: '' },
                actual: { employee: '', branch: '', month: '', year: '' },
                report: { employee: '', branch: '', month: '', year: '', visitStatus: '' }
            }
        };

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        // NOTICE: Functions like firebase.initializeApp are now available globally without 'window.' prefix
        const initFirebase = async () => {
            try {
                // Check if Firebase was successfully loaded by the script tags
                if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                    console.error("Firebase SDK not available globally. Check your script tags and network.");
                    showModal('Initialization Error', 'The Firebase SDK failed to load. Please check your browser console for Syntax Errors or ensure you are running on a local web server.');
                    return;
                }

                // Initialize the app (We use 'firebase' directly now)
                app = firebase.initializeApp(firebaseConfig);
                // Note: Compat SDK uses 'firebase.auth()' and 'firebase.firestore()'
                auth = firebase.auth(app);
                db = firebase.firestore(app);

                // Handle initial authentication
                await auth.signInAnonymously();

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        state.userId = user.uid;
                        await fetchUserProfile(user.uid);
                        authReady = true;

                        if (state.userProfile) {
                            state.currentPage = 'Dashboard';
                            setupDataListeners();
                        }
                    } else {
                        state.userId = null;
                        state.userProfile = null;
                        state.plans = [];
                        authReady = true;
                        state.currentPage = 'Login';
                    }
                    render();
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // This error often means a config key is missing or incorrect
                showModal('Error', `Failed to initialize application: ${error.message}. Ensure your API keys and project are correct in firebaseConfig.`);
            }
        };

        // --- FIRESTORE HELPERS ---
        // NOTE: Uses db.collection and doc.ref instead of the modular firebase.collection(db, ...)
        const getPlanCollectionRef = () => db.collection(`artifacts/${appId}/public/data/plans`);
        const getUserProfileDocRef = (uid) => db.doc(`artifacts/${appId}/users/${uid}/userProfiles/${uid}`);

        /**
         * Fetches the user's profile (role and branch).
         */
        const fetchUserProfile = async (uid) => {
            try {
                const docRef = getUserProfileDocRef(uid);
                const docSnap = await docRef.get(); // Use docRef.get()
                if (docSnap.exists) {
                    state.userProfile = docSnap.data();
                } else {
                    // New user or anonymous user: keep on Login page, don't auto-redirect to Register
                    state.userProfile = null;
                    // Don't change currentPage here - user will click "Register Now" if needed
                }
            } catch (e) {
                console.error("Error fetching user profile:", e);
                showModal('Error', `Could not load user profile: ${e.message}`);
            }
        };

        /**
         * Sets up real-time listeners for plans based on user role.
         */
        const setupDataListeners = () => {
            if (!db || !state.userProfile) return;
            const { role, branch } = state.userProfile;
            const plansRef = getPlanCollectionRef();
            let q = plansRef; // Start with the base collection reference

            if (role === 'Sales Person') {
                q = plansRef.where('salespersonId', '==', state.userId);
            } else if (role === 'Branch Head') {
                q = plansRef.where('branch', '==', branch);
            }
            
            // Master gets all plans (no 'where' clause needed)

            q.onSnapshot((snapshot) => {
                const plansData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Deserialize JSON strings back to objects
                    if (data.customers && typeof data.customers === 'string') data.customers = JSON.parse(data.customers);
                    if (data.unitTargets && typeof data.unitTargets === 'string') data.unitTargets = JSON.parse(data.unitTargets);
                    if (data.unitActuals && typeof data.unitActuals === 'string') data.unitActuals = JSON.parse(data.unitActuals);

                    // Ensure data fields are arrays/objects even if Firestore saves them differently
                    if (!data.customers) data.customers = [];
                    if (!data.unitTargets) data.unitTargets = [];
                    if (!data.unitActuals) data.unitActuals = [];
                    plansData.push({ id: doc.id, ...data });
                });
                state.plans = plansData;
                
                // AUTO-LOAD: On first data load for Dashboard, apply default filters to show KPI data immediately
                if (!state.dataLoaded && state.currentPage === 'Dashboard') {
                    state.dataLoaded = true;
                    // Apply dashboard filters which will render and init charts
                    applyDashboardFilters();
                    return; // Don't call render() again
                }
                
                // Re-apply current filters if they exist (preserve filter state across data updates)
                if (state.filteredPlans.length > 0) {
                    // Check if any filter inputs have values set
                    const hasActiveFilters = 
                        document.getElementById('dash-employee')?.value ||
                        document.getElementById('dash-branch')?.value ||
                        document.getElementById('dash-month')?.value ||
                        document.getElementById('dash-year')?.value ||
                        document.getElementById('act-employee')?.value ||
                        document.getElementById('act-branch')?.value ||
                        document.getElementById('act-month')?.value ||
                        document.getElementById('act-year')?.value ||
                        document.getElementById('rep-employee')?.value ||
                        document.getElementById('rep-branch')?.value ||
                        document.getElementById('rep-month')?.value ||
                        document.getElementById('rep-year')?.value ||
                        document.getElementById('rep-visit-status')?.value;
                    
                    // If there are active filters, re-apply them by calling the appropriate filter function
                    if (hasActiveFilters) {
                        if (state.currentPage === 'Dashboard') {
                            applyDashboardFilters();
                        } else if (state.currentPage === 'Actual') {
                            applyActualFilters();
                        } else if (state.currentPage === 'Report') {
                            applyReportFilters();
                        }
                        return; // Don't call render() again, the filter functions will do it
                    }
                }
                state.filteredPlans = []; // Reset if no filters are active
                render();
                // Initialize charts after dashboard renders on first data load
                // Use requestAnimationFrame to ensure DOM is fully rendered before charts init
                if (state.currentPage === 'Dashboard') {
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            initCharts();
                        }, 50);
                    });
                }
                console.log("Plans updated:", plansData.length);
            }, (error) => {
                console.error("Error setting up plans listener:", error);
                console.error("Error Code:", error.code);
                console.error("Error Message:", error.message);
                console.log("Current User Role:", state.userProfile?.role);
                console.log("Current User Branch:", state.userProfile?.branch);
                console.log("Current User ID:", state.userId);
                
                if (error.code === 'permission-denied') {
                    console.warn("Permission denied accessing plans. This may be due to Firestore Security Rules.");
                    // Don't show error modal, instead quietly log it and set plans to empty
                    state.plans = [];
                    render();
                } else {
                    showModal('Ã¢Å¡ Ã¯Â¸Â Data Load Error', `Failed to load live data: ${error.message}\n\nCheck browser console (F12) for details.`);
                }
            });


        };

        // --- UTILITIES (Rest of the functions remain the same) ---

        /** Shows a persistent, non-blocking message box for errors/info. */
        const showModal = (title, content) => {
            state.modal = { isOpen: true, title, content };
            render();
        };

        /** Closes the modal. */
        const closeModal = () => {
            state.modal = { isOpen: false, title: '', content: '' };
            render();
        };

        /** Utility to navigate between pages */
        window.navigate = (page) => {
            state.currentPage = page;
            state.actualDetails = null; // Clear actual form context when navigating
            // Auto-apply filters when navigating to Actual tab
            if (page === 'Actual' && state.plans.length > 0) {
                // Check if filters are already set, if not just render
                const hasFilters = state.filters.actual && (state.filters.actual.employee || state.filters.actual.branch || state.filters.actual.month || state.filters.actual.year);
                if (hasFilters) {
                    applyActualFilters();
                    return;
                }
            }
            render();
        };

        /** Utility to format large numbers as K/M or normal format */
        const formatDisplayValue = (value, displayFormat = 'auto') => {
            if (displayFormat === 'k') {
                return (value / 1000).toFixed(1) + ' K';
            } else if (displayFormat === 'm') {
                return (value / 1000000).toFixed(1) + ' M';
            }
            // Auto mode and default: show normal formatted numbers
            return value.toLocaleString('en-IN');
        };

        /** Formats target/actual data for charting/KPIs. */
const calculateMetrics = (plans) => {
    let totalVisits = 0;
    let completedVisits = 0;
    let pendingVisits = 0;
    let totalTarget = 0;
    let totalActual = 0;
    let planActivatedCount = 0;
    let actualDoneCount = 0;
    let actualPendingCount = 0;
    const unitData = {};
    const branchData = {};
    const visitStatusCounts = { 'Pending': 0, 'Visit Done': 0, 'Not Visit': 0 };
    const activeSalespersons = new Set();
    const activeBranches = new Set();
    const allCustomers = new Set();
    
    UNITS.forEach(u => unitData[u] = { target: 0, actual: 0 });
    BRANCHES.forEach(b => branchData[b] = { target: 0, actual: 0 });

    plans.forEach(plan => {
        // ðŸ”§ FIX: Ensure all data is properly deserialized BEFORE processing
        
        // Handle unitTargets
        if (plan.unitTargets && typeof plan.unitTargets === 'string') {
            try {
                plan.unitTargets = JSON.parse(plan.unitTargets);
            } catch (e) {
                console.error("Failed to parse unitTargets for plan", plan.id, e);
                plan.unitTargets = [];
            }
        }
        if (!Array.isArray(plan.unitTargets)) {
            plan.unitTargets = [];
        }

        // Handle unitActuals
        if (plan.unitActuals && typeof plan.unitActuals === 'string') {
            try {
                plan.unitActuals = JSON.parse(plan.unitActuals);
            } catch (e) {
                console.error("Failed to parse unitActuals for plan", plan.id, e);
                plan.unitActuals = [];
            }
        }
        if (!Array.isArray(plan.unitActuals)) {
            plan.unitActuals = [];
        }

        // Handle customers
        if (plan.customers && typeof plan.customers === 'string') {
            try {
                plan.customers = JSON.parse(plan.customers);
            } catch (e) {
                console.error("Failed to parse customers for plan", plan.id, e);
                plan.customers = [];
            }
        }
        if (!Array.isArray(plan.customers)) {
            plan.customers = [];
        }

        // Now safely process the data
        activeSalespersons.add(plan.salespersonId);
        activeBranches.add(plan.branch);

        if (plan.status === 'Planned') {
            planActivatedCount++;
        }

        if (plan.customers && plan.customers.length > 0) {
            totalVisits += plan.customers.length;
            plan.customers.forEach(cust => {
                allCustomers.add(cust.name);
                const status = cust.visitStatus || 'Pending';
                if (status === 'Visit Done') {
                    completedVisits++;
                    actualDoneCount++;
                }
                if (status === 'Pending') {
                    pendingVisits++;
                    actualPendingCount++;
                }

                if (status === 'Not Visit') visitStatusCounts['Not Visit']++;
                else if (status === 'Visit Done') visitStatusCounts['Visit Done']++;
                else visitStatusCounts['Pending']++;
            });
        }

        if (plan.unitTargets && plan.unitTargets.length > 0) {
            plan.unitTargets.forEach(ut => {
                totalTarget += ut.target || 0;
                unitData[ut.unit] = unitData[ut.unit] || { target: 0, actual: 0 };
                unitData[ut.unit].target += ut.target || 0;

                branchData[plan.branch] = branchData[plan.branch] || { target: 0, actual: 0 };
                branchData[plan.branch].target += ut.target || 0;
            });
        }

        if (plan.unitActuals && plan.unitActuals.length > 0) {
            plan.unitActuals.forEach(ua => {
                totalActual += ua.actual || 0;
                unitData[ua.unit] = unitData[ua.unit] || { target: 0, actual: 0 };
                unitData[ua.unit].actual += ua.actual || 0;

                branchData[plan.branch] = branchData[plan.branch] || { target: 0, actual: 0 };
                branchData[plan.branch].actual += ua.actual || 0;
            });	
        }
    });

    return {
        totalVisits,
        completedVisits,
        pendingVisits: visitStatusCounts['Pending'],
        totalTarget,
        totalActual,
        visitStatusCounts,
        unitData,
        branchData,
        activeSalespersonsCount: activeSalespersons.size,
        activeBranchesCount: activeBranches.size,
        totalCustomersCount: allCustomers.size,
        planActivatedCount,
        actualDoneCount,
        actualPendingCount
    };
};
        /** Generates CSV content from an array of objects. */
        const generateCSV = (data) => {
            if (!data || data.length === 0) return '';

            const headers = Object.keys(data[0]).filter(key => key !== 'customers' && key !== 'unitTargets' && key !== 'unitActuals');
            
            // Handle nested data for CSV (simplified approach)
            let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';

            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];

                    if (value instanceof firebase.firestore.Timestamp) {
                        value = new Date(value.toMillis()).toLocaleDateString();
                    } else if (typeof value === 'string' && value.includes(',')) {
                        // Escape commas in strings
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvContent += values.join(',') + '\n';
            });

            return csvContent;
        };

        // --- RENDERING FUNCTIONS ---

        const render = () => {
            const appContainer = document.getElementById('app');
            const initialLoader = document.getElementById('initial-loading-screen');
            if (!appContainer) return;
            
            // Remove the initial static loader once rendering starts
            if (initialLoader) {
                initialLoader.remove();
            }

            let content = '';

            if (state.loading) {
                content = renderLoading();
            } else if (!authReady || state.currentPage === 'Login' || state.currentPage === 'Register') {
                content = renderAuthScreen();
            } else {
                content = renderMainApp();
            }

            appContainer.innerHTML = content;
            attachEventListeners();
        };

        const renderLoading = () => `
            <div class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary"></div>
                <p class="text-secondary ml-4">Loading...</p>
            </div>
        `;

        // --- AUTH UI (Login/Register) ---

        const renderAuthScreen = () => {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md w-full space-y-8 bg-white p-8 shadow-2xl rounded-xl">
                        <div class="text-center">
                            <img class="mx-auto h-16 w-auto rounded-lg" src="${COMPANY_LOGO_URL}" alt="${COMPANY_NAME}" onerror="this.onerror=null;this.src='https://placehold.co/64x64/10a5e8/ffffff?text=GINZA';">
                            <h2 class="mt-6 text-3xl font-extrabold text-gray-900">
                                ${state.currentPage === 'Login' ? 'Sign in to your account' : 'Create New Account'}
                            </h2>
                            <p class="mt-2 text-sm text-gray-600">
                                ${COMPANY_NAME} Sales Portal
                            </p>
                        </div>
                        ${state.currentPage === 'Login' ? renderLoginForm() : renderRegisterForm()}
                        <div class="text-center">
                            <button id="toggle-auth-mode" class="text-sm text-primary hover:text-blue-700 font-medium transition">
                                ${state.currentPage === 'Login' ? 'Don\'t have an account? Register Now' : 'Already have an account? Sign In'}
                            </button>
                            <p class="text-xs text-gray-400 mt-2">
                                User ID: ${state.userId ? state.userId.substring(0, 8) + '...' : 'Anonymous'}
                            </p>
                        </div>
                    </div>
                </div>
                ${renderModal()}
            `;
        };

        const renderLoginForm = () => `
            <form class="mt-8 space-y-6" id="login-form">
                <input type="hidden" name="remember" value="true">
                <div class="rounded-md shadow-sm space-y-3">
                    <div>
                        <label for="login-email" class="sr-only">Email address</label>
                        <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="login-password" class="sr-only">Password</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition">
                        Sign in
                    </button>
                </div>
            </form>
        `;

        const renderRegisterForm = () => `
            <form class="mt-8 space-y-6" id="register-form">
                <div class="rounded-md shadow-sm space-y-3">
                    <div>
                        <label for="reg-email" class="sr-only">Email</label>
                        <input id="reg-email" name="email" type="email" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm" placeholder="Email Address">
                    </div>
                    <div>
                        <label for="reg-firstname" class="sr-only">First Name</label>
                        <input id="reg-firstname" name="firstname" type="text" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm" placeholder="First Name">
                    </div>
                    <div>
                        <label for="reg-lastname" class="sr-only">Last Name</label>
                        <input id="reg-lastname" name="lastname" type="text" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm" placeholder="Last Name">
                    </div>
                    <div class="relative">
                        <label for="reg-password" class="sr-only">Password</label>
                        <input id="reg-password" name="password" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-3 pr-10 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm" placeholder="Password">
                        <button type="button" id="reg-password-toggle" class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                    </div>
                    <div class="relative">
                        <label for="reg-confirm-password" class="sr-only">Confirm Password</label>
                        <input id="reg-confirm-password" name="confirmpassword" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-3 pr-10 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm" placeholder="Confirm Password">
                        <button type="button" id="reg-confirm-password-toggle" class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                    </div>
                    <div>
                        <label for="reg-role" class="sr-only">Role</label>
                        <select id="reg-role" name="role" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                            <option value="">Select Role</option>
                            <option value="Sales Person">Sales Person</option>
                            <option value="Branch Head">Branch Head</option>
                            <option value="Master">Master</option>
                        </select>
                    </div>
                    <div id="branch-select-container">
                        <label for="reg-branch" class="sr-only">Branch</label>
                        <select id="reg-branch" name="branch" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-300 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                            <option value="">Select Branch</option>
                            ${BRANCHES.map(b => `<option value="${b}">${b}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-accent hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition">
                        Register & Sign in
                    </button>
                </div>
            </form>
        `;

        // --- AUTH HANDLERS ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            state.loading = true;
            render();

            const email = e.target['login-email'].value;
            const password = e.target['login-password'].value;

            try {
                // Use the global auth object
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // The onAuthStateChanged listener handles state change and rendering
                console.log("Login successful:", userCredential.user.uid);

            } catch (error) {
                console.error("Login Failed:", error);
                showModal('Login Failed', `Error: ${error.message}`);
            } finally {
                state.loading = false;
                render();
            }
        };

        window.handleRegister = async (e) => {
            e.preventDefault();
            state.loading = true;
            render();

            const form = e.target;
            const email = form['reg-email'].value;
            const firstname = form['reg-firstname'].value;
            const lastname = form['reg-lastname'].value;
            const fullName = `${firstname} ${lastname}`;
            const password = form['reg-password'].value;
            const confirmpassword = form['reg-confirm-password'].value;
            const role = form['reg-role'].value;
            let branch = form['reg-branch'].value;

            // Validation
            if (password !== confirmpassword) {
                showModal('Validation Error', 'Passwords do not match. Please try again.');
                state.loading = false;
                render();
                return;
            }

            if (password.length < 6) {
                showModal('Validation Error', 'Password must be at least 6 characters long.');
                state.loading = false;
                render();
                return;
            }

            // If Master role, set branch to all branches
            if (role === 'Master') {
                branch = 'All Branches';
            }

            try {
                // 1. Create User
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                // 2. Save Profile Data to Firestore
                const profileData = {
                    fullName,
                    firstName: firstname,
                    lastName: lastname,
                    email,
                    branch,
                    role,
                    createdAt: firebase.firestore.Timestamp.now()
                };
                
                const profileDocRef = getUserProfileDocRef(uid);
                await profileDocRef.set(profileData);

                showModal('Registration Success', `Welcome, ${fullName}! Your account has been created. Signing you in...`);
                // onAuthStateChanged listener handles the rest
            } catch (error) {
                console.error("Registration Failed:", error);
                showModal('Registration Failed', `Error: ${error.message}`);
            } finally {
                state.loading = false;
                render();
            }
        };

        window.handleLogout = async () => {
            try {
                await auth.signOut();
                // AuthStateChanged listener handles navigation to Login
            } catch (error) {
                console.error("Logout failed:", error);
            }
        };

        // --- NEW PLAN HANDLERS & UI ---

        const renderCustomerInput = (customer = { name: '', visitStatus: 'Pending', remark: '', isNew: true }, index, isActual = false, allowEdit = true) => {
            const isCompleted = isActual && !allowEdit && (customer.visitStatus === 'Visit Done' || customer.visitStatus === 'Not Visit');
            
            if (!isActual) {
                // New Plan: Simple customer name only, no remove button
                return `
                    <div class="p-3 border border-gray-200 rounded-lg bg-gray-50 customer-row" data-index="${index}">
                        <div class="grid grid-cols-1 md:grid-cols-1 gap-3 items-end">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Customer Name</label>
                                <input type="text" name="customer-name" value="${customer.name}" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-primary focus:border-primary">
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Actual Tab: Customer name with status and remark + save button
                return `
                    <div class="p-3 border border-gray-200 rounded-lg bg-gray-50 customer-row" data-index="${index}">
                        <div class="grid grid-cols-1 md:grid-cols-8 gap-3 items-end">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Customer Name</label>
                                <input type="text" name="customer-name" value="${customer.name}" ${isCompleted ? 'disabled' : ''} class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-primary focus:border-primary ${isCompleted ? 'bg-gray-100' : ''}">
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
                                <select name="visit-status" ${isCompleted ? 'disabled' : ''} class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-primary focus:border-primary ${isCompleted ? 'bg-gray-100' : ''}">
                                    <option value="Pending" ${customer.visitStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="Visit Done" ${customer.visitStatus === 'Visit Done' ? 'selected' : ''}>Visit Done</option>
                                    <option value="Not Visit" ${customer.visitStatus === 'Not Visit' ? 'selected' : ''}>Not Visit</option>
                                </select>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Remark (Max ${MAX_REMARK_LENGTH})</label>
                                <textarea name="remark" maxlength="${MAX_REMARK_LENGTH}" ${isCompleted ? 'disabled' : ''} class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-primary focus:border-primary ${isCompleted ? 'bg-gray-100' : ''}">${customer.remark}</textarea>
                            </div>
                            ${!isCompleted ? `
                                <div class="md:col-span-2 flex items-end gap-2">
                                    <button type="button" onclick="saveCustomerRemark(${index})" class="flex-1 p-2 bg-green-100 text-green-700 rounded-lg text-sm hover:bg-green-200 transition font-medium" title="Save remark only (dont complete plan)">
                                        Save Remark
                                    </button>
                                    <button type="button" onclick="removeCustomerRow(${index}, ${isActual})" class="flex-1 p-2 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200 transition">
                                        Remove
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        };
        
        // Internal state for New Plan form
        if (!state.newPlan) {
            state.newPlan = {
                customers: [ { name: '', visitStatus: 'Pending', remark: '', isNew: true } ],
                unitTargets: UNITS.map(u => ({ unit: u, target: 0 }))
            };
        }

        window.addCustomerRow = (isActual) => {
            if (isActual && state.actualDetails) {
                console.log("=== BEFORE ADD CUSTOMER ===");
                console.log("Current customers from state:", JSON.stringify(state.actualDetails.customers));
                
                // IMPORTANT: Save current customer form data BEFORE adding new customer
                // This ensures we don't lose any existing data when adding a new customer
                const listContainer = document.getElementById('modal-actual-customer-list') || document.getElementById('actual-customer-list');
                if (!listContainer) {
                    console.error("List container not found!");
                    return;
                }
                
                const currentCustomerRows = listContainer.querySelectorAll('.customer-row');
                console.log("Found customer rows:", currentCustomerRows.length);
                
                // Preserve all existing customer data from form inputs (DO NOT MODIFY STATE YET)
                const savedCustomers = [];
                
                currentCustomerRows.forEach((row, index) => {
                    const nameInput = row.querySelector('[name="customer-name"]');
                    const statusSelect = row.querySelector('[name="visit-status"]');
                    const remarkTextarea = row.querySelector('[name="remark"]');
                    
                    const data = {
                        name: nameInput ? nameInput.value : '',
                        visitStatus: statusSelect ? statusSelect.value : 'Pending',
                        remark: remarkTextarea ? remarkTextarea.value : '',
                        isNew: false
                    };
                    console.log(`Customer ${index}:`, data);
                    
                    if (nameInput && statusSelect && remarkTextarea) {
                        savedCustomers.push(data);
                    }
                });
                
                console.log("Saved customers:", JSON.stringify(savedCustomers));
                
                // Update state with saved customer data
                state.actualDetails.customers = [...savedCustomers];
                
                // Now add the new empty customer to state
                state.actualDetails.customers.push({ name: '', visitStatus: 'Pending', remark: '', isNew: false });
                
                console.log("=== AFTER ADD CUSTOMER ===");
                console.log("Updated state.actualDetails.customers:", JSON.stringify(state.actualDetails.customers));
                
                // Create new customer HTML
                const newIndex = state.actualDetails.customers.length - 1;
                const newCustomerHTML = renderCustomerInput(state.actualDetails.customers[newIndex], newIndex, true);
                
                // Add to DOM WITHOUT re-rendering entire modal
                listContainer.insertAdjacentHTML('beforeend', newCustomerHTML);
                
                // Focus on the new customer name input
                setTimeout(() => {
                    const newCustomerInput = listContainer.querySelector(`.customer-row[data-index="${newIndex}"] [name="customer-name"]`);
                    if (newCustomerInput) {
                        newCustomerInput.focus();
                        newCustomerInput.select();
                    }
                }, 50);
            } else if (!isActual) {
                // For New Plan: Get the input value from the single input box
                const customerInput = document.getElementById('new-customer-name-input');
                const startDateInput = document.getElementById('plan-start-date');
                const endDateInput = document.getElementById('plan-end-date');
                
                if (!customerInput) return;
                
                const customerName = customerInput.value.trim();
                if (!customerName) {
                    showModal('Validation Error', 'Please enter a customer name.');
                    return;
                }
                
                // Save form data (dates) before adding customer
                if (startDateInput) state.newPlanFormData.startDate = startDateInput.value;
                if (endDateInput) state.newPlanFormData.endDate = endDateInput.value;
                
                // Add customer to state
                state.newPlan.customers.push({ name: customerName, visitStatus: 'Pending', remark: '', isNew: true });
                
                // Clear the input box and focus back to it
                customerInput.value = '';
                customerInput.focus();
                
                // Re-render the form to show updated customer list
                render();
                
                // Restore form data after render
                setTimeout(() => {
                    const newStartDateInput = document.getElementById('plan-start-date');
                    const newEndDateInput = document.getElementById('plan-end-date');
                    if (newStartDateInput && state.newPlanFormData.startDate) {
                        newStartDateInput.value = state.newPlanFormData.startDate;
                    }
                    if (newEndDateInput && state.newPlanFormData.endDate) {
                        newEndDateInput.value = state.newPlanFormData.endDate;
                    }
                    // Focus back to customer input
                    const newCustomerInput = document.getElementById('new-customer-name-input');
                    if (newCustomerInput) newCustomerInput.focus();
                }, 50);
            }
        };

        // Helper function to update only the customer list display without clearing form data
        const updateCustomerListDisplay = () => {
            // This function is deprecated - use insertAdjacentHTML for Actual form instead
        };
        
        window.removeNewCustomer = (index) => {
            const confirm = window.confirm('Remove this customer?');
            if (!confirm) return;
            state.newPlan.customers.splice(index, 1);
            render();
        };

        window.removeCustomerRow = (index, isActual) => {
            const confirm = window.confirm('Are you sure you want to remove this customer?');
            if (!confirm) return;

            if (isActual && state.actualDetails) {
                state.actualDetails.customers.splice(index, 1);
                
                if (state.modal.isOpen && state.modal.isForm) {
                    // Update modal content
                    const modalContent = renderActualModalContent(state.actualDetails);
                    state.modal = { isOpen: true, title: 'Update Actual Details', content: modalContent, isForm: true };
                }
                render();
            } else if (state.newPlan) {
                state.newPlan.customers.splice(index, 1);
                render();
                navigate('NewPlan');
            }
        };

        const renderNewPlanForm = () => {
            const plan = state.newPlan;
            const userProfile = state.userProfile;

            return `
                <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                    <h2 class="text-3xl font-extrabold text-primary mb-6 border-b pb-4">Create New Sales Plan</h2>
                    
                    <form id="new-plan-form" class="space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm bg-gray-50 p-4 rounded-lg shadow-inner">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Employee Name</label>
                                <p class="font-semibold text-secondary">${userProfile.fullName}</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Branch</label>
                                <p class="font-semibold text-secondary">${userProfile.branch}</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">User Role</label>
                                <p class="font-semibold text-secondary">${userProfile.role}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-b pb-6">
                            <div>
                                <label for="plan-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input type="date" id="plan-start-date" name="plan-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label for="plan-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                <input type="date" id="plan-end-date" name="plan-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary">
                            </div>
                        </div>
                        
                        <div class="space-y-4 border-b pb-6 customer-visit-plan-section">
                            <h3 class="text-xl font-semibold text-secondary">Customer Visit Plan</h3>
                            
                            <div class="flex gap-3">
                                <div class="flex-1">
                                    <input type="text" id="new-customer-name-input" placeholder="Enter customer name" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary">
                                </div>
                                <button type="button" id="add-customer-plan-btn" class="flex items-center px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-blue-700 transition whitespace-nowrap">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    Add
                                </button>
                            </div>
                            
                            ${plan.customers && plan.customers.filter(c => c.name.trim() !== '').length > 0 ? `
                                <div class="mt-4 space-y-2" id="customer-list-display">
                                    <p class="text-xs font-medium text-gray-600">Added Customers (${plan.customers.filter(c => c.name.trim() !== '').length}):</p>
                                    ${plan.customers.filter(c => c.name.trim() !== '').map((c, index) => {
                                        const originalIndex = plan.customers.indexOf(c);
                                        return `
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg border border-gray-200">
                                            <span class="text-sm text-gray-800">${c.name}</span>
                                            <button type="button" onclick="removeNewCustomer(${originalIndex})" class="text-xs px-2 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 transition">Remove</button>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-dashed border-gray-300 text-center">
                                    <p class="text-xs text-gray-500">No customers added yet. Add customer names above.</p>
                                </div>
                            `}
                        </div>

                        <div class="space-y-4 border-b pb-6">
                            <h3 class="text-xl font-semibold text-secondary">Unit Target Planning (Value in Rs.)</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden shadow-md">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left">Unit</th>
                                            <th class="px-4 py-2 text-left">Target (Rs.)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="unit-target-table-body">
                                        ${plan.unitTargets.map((ut, idx) => `
                                            <tr>
                                                <td class="px-4 py-2 font-semibold text-secondary">${ut.unit}</td>
                                                <td class="px-4 py-2">
                                                    <input type="text" class="target-input w-full px-2 py-1 border border-gray-300 rounded-md text-sm focus:ring-primary focus:border-primary" data-unit="${ut.unit}" value="${ut.target || ''}" autocomplete="off">
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="pt-6">
                            <button type="submit" class="w-full py-3 px-4 border border-transparent text-lg font-medium rounded-full text-white bg-accent hover:bg-yellow-600 shadow-xl transition">
                                Submit Plan
                            </button>
                        </div>
                    </form>
                </div>
            `;
        };
        
        const handlePlanSubmit = async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const startDateInput = form.querySelector('[name="plan-start-date"]');
            const endDateInput = form.querySelector('[name="plan-end-date"]');
            const startDate = startDateInput ? startDateInput.value.trim() : '';
            const endDate = endDateInput ? endDateInput.value.trim() : '';

            console.log("Form submit - Start Date:", startDate, "End Date:", endDate);

            // Validate dates
            if (!startDate || !endDate) {
                showModal('Validation Error', 'Please select both Start Date and End Date.');
                return;
            }

            const today = firebase.firestore.Timestamp.fromDate(new Date());

            // 1. Extract Customer Data - Use state.newPlan.customers directly
            const customers = state.newPlan.customers.filter(c => c.name.trim() !== '').map(c => ({
                name: c.name.trim(),
                visitStatus: 'Pending',
                remark: '',
                isNew: true
            }));

            // 2. Extract Unit Target Data
            const unitTargetInputs = document.querySelectorAll('#unit-target-table-body .target-input');
            const unitTargets = Array.from(unitTargetInputs).map(input => ({
                unit: input.getAttribute('data-unit'),
                target: parseInt(input.value) || 0
            })).filter(ut => ut.target > 0);

            if (customers.length === 0) {
                showModal('Validation Error', 'Please add at least one customer with a valid name to the plan.');
                state.loading = false;
                render();
                return;
            }
            if (unitTargets.length === 0) {
                showModal('Validation Error', 'Please enter a target amount for at least one unit.');
                state.loading = false;
                render();
                return;
            }

            const planData = {
                salespersonId: state.userId,
                salespersonName: state.userProfile.fullName,
                branch: state.userProfile.branch,
                startDate: firebase.firestore.Timestamp.fromDate(new Date(startDate)),
                endDate: firebase.firestore.Timestamp.fromDate(new Date(endDate)),
                status: 'Planned', // Planned, Completed, Canceled
                customers: JSON.stringify(customers), // Stringify complex array for Firestore
                unitTargets: JSON.stringify(unitTargets), // Stringify complex array for Firestore
                unitActuals: JSON.stringify([]), // Initialize as empty actuals
                createdAt: today,
                updatedAt: today
            };

            try {
                // Save plan to Firestore
                await getPlanCollectionRef().add(planData); // Use ref.add(data)

                // Reset form element
                form.reset();
                // Reset local state for new plan form and re-render
                state.newPlan = {
                    customers: [ { name: '', visitStatus: 'Pending', remark: '', isNew: true } ],
                    unitTargets: UNITS.map(u => ({ unit: u, target: 0 }))
                };
                state.newPlanFormData = { startDate: '', endDate: '' };
                showModal('Success', 'New Sales Plan submitted successfully!');
                // Navigate to Actual tab so user can see the new plan in Pending Actualization list
                navigate('Actual');

            } catch (error) {
                console.error("Plan submission failed:", error);
                showModal('Error', `Plan submission failed: ${error.message}`);
            }
        };


        // --- ACTUAL TAB UI & HANDLERS ---
        
        const filterPlansByRole = (plans) => {
            if (!state.userProfile) return [];

            const { role, branch } = state.userProfile;

            // Client-side filtering logic matching the security rules intent
            if (role === 'Master') {
                return plans; // Master sees all
            } else if (role === 'Branch Head') {
                return plans.filter(p => p.branch === branch); // Branch Head sees their branch only
            } else if (role === 'Sales Person') {
                return plans.filter(p => p.salespersonId === state.userId); // Sales Person sees their plans only
            }
            return [];
        };

        // Apply Dashboard filters
        const applyDashboardFilters = () => {
            const employeeValue = document.getElementById('dash-employee')?.value || '';
            const branchFilter = document.getElementById('dash-branch')?.value || '';
            const monthFilter = document.getElementById('dash-month')?.value || '';
            const yearFilter = document.getElementById('dash-year')?.value || '';

            // Save filter values to state for persistence (store original case)
            state.filters.dashboard = { employee: employeeValue, branch: branchFilter, month: monthFilter, year: yearFilter };

            // Get base plans accessible by user role
            let basePlans = filterPlansByRole(state.plans);
            
            console.log("Ã°Å¸â€Â Employee Filter Applied:", {
                value: employeeValue,
                allEmployees: [...new Set(basePlans.map(p => p.salespersonName))],
                basePlansCount: basePlans.length
            });
            
            // If NO filters are selected, show all data for the role
            // If ANY filters are selected, apply them
            if (!employeeValue && !branchFilter && !monthFilter && !yearFilter) {
                // No filters selected - show all plans for this role
                state.filteredPlans = basePlans;
                console.log("Ã°Å¸â€œÅ  Dashboard: No filters selected - showing all", basePlans.length, "plans");
            } else {
                // Filters selected - apply them
                state.filteredPlans = basePlans.filter(p => {
                    const planDate = p.startDate.toDate ? new Date(p.startDate.toDate()) : new Date(p.startDate);
                    const planMonth = planDate.toLocaleString('en', { month: 'long' });
                    const planYear = planDate.getFullYear().toString();
                    
                    // Check if employee name matches (case-sensitive for exact match from dropdown)
                    const employeeMatches = !employeeValue || p.salespersonName === employeeValue;
                    
                    return employeeMatches &&
                           (!branchFilter || p.branch === branchFilter) &&
                           (!monthFilter || planMonth === monthFilter) &&
                           (!yearFilter || planYear === yearFilter);
                });
                console.log("Ã°Å¸â€œÅ  Dashboard: Filters applied - showing", state.filteredPlans.length, "filtered plans", {
                    employee: employeeValue,
                    branch: branchFilter,
                    month: monthFilter,
                    year: yearFilter
                });
            }
            
            render();
            // Ensure charts are initialized after DOM render completes
            // Use requestAnimationFrame for proper DOM rendering before chart init
            requestAnimationFrame(() => {
                setTimeout(() => {
                    initCharts();
                }, 50);
            });
        };

        // Apply Actual filters
        const applyActualFilters = () => {
            const employeeFilter = (document.getElementById('act-employee')?.value || '').toLowerCase();
            const branchFilter = document.getElementById('act-branch')?.value || '';
            const monthFilter = document.getElementById('act-month')?.value || '';
            const yearFilter = document.getElementById('act-year')?.value || '';

            // Save filter values to state for persistence
            state.filters.actual = { employee: employeeFilter, branch: branchFilter, month: monthFilter, year: yearFilter };

            state.filteredPlans = filterPlansByRole(state.plans).filter(p => {
                const planDate = p.startDate.toDate ? new Date(p.startDate.toDate()) : new Date(p.startDate);
                const planMonth = planDate.toLocaleString('en', { month: 'long' });
                const planYear = planDate.getFullYear().toString();
                
                // Check if employee name matches (exact match for dropdown, not contains)
                const employeeMatches = !employeeFilter || p.salespersonName.toLowerCase() === employeeFilter;
                
                return employeeMatches &&
                       (!branchFilter || p.branch === branchFilter) &&
                       (!monthFilter || planMonth === monthFilter) &&
                       (!yearFilter || planYear === yearFilter);
            });
            render();
        };

        // Apply Report filters
        const applyReportFilters = () => {
            const employeeFilter = (document.getElementById('rep-employee')?.value || '').toLowerCase();
            const branchFilter = document.getElementById('rep-branch')?.value || '';
            const monthFilter = document.getElementById('rep-month')?.value || '';
            const yearFilter = document.getElementById('rep-year')?.value || '';
            const visitStatusFilter = document.getElementById('rep-visit-status')?.value || '';

            // Save filter values to state for persistence
            state.filters.report = { employee: employeeFilter, branch: branchFilter, month: monthFilter, year: yearFilter, visitStatus: visitStatusFilter };

            state.filteredPlans = filterPlansByRole(state.plans).filter(p => {
                const planDate = p.startDate.toDate ? new Date(p.startDate.toDate()) : new Date(p.startDate);
                const planMonth = planDate.toLocaleString('en', { month: 'long' });
                const planYear = planDate.getFullYear().toString();
                
                const hasVisitStatus = !visitStatusFilter || 
                    (p.customers && p.customers.some(c => c.visitStatus === visitStatusFilter));
                
                // Check if employee name matches (exact match for dropdown, not contains)
                const employeeMatches = !employeeFilter || p.salespersonName.toLowerCase() === employeeFilter;
                
                return employeeMatches &&
                       (!branchFilter || p.branch === branchFilter) &&
                       (!monthFilter || planMonth === monthFilter) &&
                       (!yearFilter || planYear === yearFilter) &&
                       hasVisitStatus;
            });
            render();
        };

        const renderActualList = () => {
            // Filter plans that are 'Planned' and accessible by the current user
            // If filters are applied, use filtered plans; otherwise use all accessible plans
            let basePlans;
            if (state.filters.actual && (state.filters.actual.employee || state.filters.actual.branch || state.filters.actual.month || state.filters.actual.year)) {
                basePlans = state.filteredPlans || filterPlansByRole(state.plans);
            } else {
                basePlans = filterPlansByRole(state.plans);
            }
            const plannedTasks = basePlans.filter(p => p.status === 'Planned');
            const userRole = state.userProfile?.role;

            return `
                <div class="space-y-6">
                    ${renderActualFilters()}

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-extrabold text-secondary">Pending Actualization (${plannedTasks.length})</h2>
                        ${(userRole === 'Master' || userRole === 'Branch Head') ? `
                            <button id="download-planning-actual-csv" class="flex items-center bg-primary text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-700 transition shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Download Report
                            </button>
                        ` : ''}
                    </div>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-2xl">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Branch</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan Date (From-To)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    ${userRole === 'Master' ? '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Delete</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${plannedTasks.length > 0 ? plannedTasks.map(plan => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${plan.branch}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-secondary">
                                            ${new Date(plan.startDate.toMillis()).toLocaleDateString()} - ${new Date(plan.endDate.toMillis()).toLocaleDateString()}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${plan.salespersonName}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="openActualModalForm('${plan.id}')" class="text-primary hover:text-blue-700 font-medium">
                                                Update Actual
                                            </button>
                                        </td>
                                        ${userRole === 'Master' ? `<td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="deletePlan('${plan.id}')" class="text-red-600 hover:text-red-800 font-medium">
                                                Delete
                                            </button>
                                        </td>` : ''}
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="${userRole === 'Master' ? '5' : '4'}" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                                            No planned tasks pending actualization.
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const renderActualFilters = () => {
            // Get unique employee names from all plans
            const allPlans = filterPlansByRole(state.plans);
            const employeeNames = [...new Set(allPlans.map(p => p.salespersonName))].sort();
            const userRole = state.userProfile?.role;
            const userBranch = state.userProfile?.branch;
            
            // For Sales Person role, hide employee and branch filters (they only see their own data)
            let filterOptions = [];
            if (userRole === 'Sales Person') {
                // Sales Person only sees month and year filters
                filterOptions = [
                    { id: 'act-month', label: 'Month', type: 'select', options: Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('en', { month: 'long' })) },
                    { id: 'act-year', label: 'Year', type: 'select', options: ['2024', '2025', '2026'] },
                ];
            } else if (userRole === 'Branch Head') {
                // Branch Head only sees their own branch + employee, month, year filters (no branch filter)
                filterOptions = [
                    { id: 'act-employee', label: 'Employee Name', type: 'select', options: employeeNames },
                    { id: 'act-month', label: 'Month', type: 'select', options: Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('en', { month: 'long' })) },
                    { id: 'act-year', label: 'Year', type: 'select', options: ['2024', '2025', '2026'] },
                ];
            } else {
                // Master sees all filters
                filterOptions = [
                    { id: 'act-employee', label: 'Employee Name', type: 'select', options: employeeNames },
                    { id: 'act-branch', label: 'Branch', type: 'select', options: BRANCHES },
                    { id: 'act-month', label: 'Month', type: 'select', options: Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('en', { month: 'long' })) },
                    { id: 'act-year', label: 'Year', type: 'select', options: ['2024', '2025', '2026'] },
                ];
            }

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-secondary mb-4">Filters</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        ${filterOptions.map(f => {
                            let currentValue = '';
                            if (f.id === 'act-employee') currentValue = state.filters.actual.employee;
                            else if (f.id === 'act-branch') currentValue = state.filters.actual.branch;
                            else if (f.id === 'act-month') currentValue = state.filters.actual.month;
                            else if (f.id === 'act-year') currentValue = state.filters.actual.year;
                            
                            return `
                            <div class="min-w-0">
                                <label for="${f.id}" class="block text-xs font-medium text-gray-700 mb-1">${f.label}</label>
                                <select id="${f.id}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary">
                                    <option value="">All ${f.label}</option>
                                    ${f.options.map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                            `;
                        }).join('')}
                        <div class="col-span-2 md:col-span-1 lg:col-span-1 flex items-end">
                            <button id="act-search-btn" class="w-full bg-primary text-white py-2 rounded-lg text-sm hover:bg-blue-700 transition">Search</button>
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.openActualModalForm = (planId) => {
            console.log("Opening actual modal for plan:", planId);
            console.log("Available plans:", state.plans ? state.plans.length : 0);
            
            if (!state.plans || state.plans.length === 0) {
                console.warn("No plans loaded. Attempting to reload...");
                showModal('Error', 'Plans data not loaded. Please refresh the page and try again.');
                return;
            }
            
            const plan = state.plans.find(p => p.id === planId);
            if (plan) {
                try {
                    console.log("Plan found, opening modal with plan:", plan.salespersonName);
                    console.log("  Original plan startDate:", plan.startDate, "Type:", typeof plan.startDate);
                    console.log("  Original plan endDate:", plan.endDate, "Type:", typeof plan.endDate);
                    
                    // Deep copy to allow editing without changing state.plans directly
                    // WARNING: This converts Firestore Timestamps to plain objects!
                    state.actualDetails = JSON.parse(JSON.stringify(plan));
                    
                    console.log("  After deep copy startDate:", state.actualDetails.startDate, "Type:", typeof state.actualDetails.startDate);
                    console.log("  After deep copy endDate:", state.actualDetails.endDate, "Type:", typeof state.actualDetails.endDate);
                    
                    // Ensure all JSON strings are properly parsed
                    if (typeof state.actualDetails.customers === 'string') {
                        try {
                            state.actualDetails.customers = JSON.parse(state.actualDetails.customers);
                        } catch (e) {
                            console.warn("Could not parse customers:", e);
                            state.actualDetails.customers = [];
                        }
                    }
                    
                    if (typeof state.actualDetails.unitTargets === 'string') {
                        try {
                            state.actualDetails.unitTargets = JSON.parse(state.actualDetails.unitTargets);
                        } catch (e) {
                            console.warn("Could not parse unitTargets:", e);
                            state.actualDetails.unitTargets = [];
                        }
                    }
                    
                    if (typeof state.actualDetails.unitActuals === 'string') {
                        try {
                            state.actualDetails.unitActuals = JSON.parse(state.actualDetails.unitActuals);
                        } catch (e) {
                            console.warn("Could not parse unitActuals:", e);
                            state.actualDetails.unitActuals = [];
                        }
                    }
                    
                    // CRITICAL FIX: Restore original Firestore Timestamps after deep copy
                    // Deep copy loses Timestamp object information, so we restore from original plan object
                    state.actualDetails.startDate = plan.startDate;
                    state.actualDetails.endDate = plan.endDate;
                    
                    console.log("  Ã¢Å“â€¦ Restored startDate:", state.actualDetails.startDate, "Type:", typeof state.actualDetails.startDate);
                    console.log("  Ã¢Å“â€¦ Restored endDate:", state.actualDetails.endDate, "Type:", typeof state.actualDetails.endDate);
                    
                    // Ensure unitActuals exists and is mapped to the current plan structure
                    if (!state.actualDetails.unitActuals || state.actualDetails.unitActuals.length === 0) {
                        state.actualDetails.unitActuals = state.actualDetails.unitTargets ? 
                            state.actualDetails.unitTargets.map(ut => ({ unit: ut.unit, target: ut.target, actual: 0 })) : [];
                    }
                    
                    // IMPORTANT: Ensure there's at least one customer row for editing (even if empty)
                    if (!state.actualDetails.customers || state.actualDetails.customers.length === 0) {
                        state.actualDetails.customers = [{ name: '', visitStatus: 'Pending', remark: '', isNew: false }];
                    }

                    // Show the modal with the actual form content
                    const modalContent = renderActualModalContent(state.actualDetails);
                    state.modal = { isOpen: true, title: 'Update Actual Details', content: modalContent, isForm: true };
                    render();
                } catch (error) {
                    console.error("Error opening modal:", error);
                    showModal('Error', `Failed to open plan: ${error.message}`);
                }
            } else {
                console.error("Plan not found with ID:", planId);
                console.error("Searched in plans:", state.plans.map(p => p.id));
                showModal('Error', 'Unable to find plan. Please refresh and try again.');
            }
        };

        window.openActualDetails = (planId) => {
            // This function is kept for backward compatibility but now just opens the modal
            openActualModalForm(planId);
        };

        const renderActualForm = (plan) => {
            
            return `
                <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl font-extrabold text-primary">Actualizing Plan: ${plan.salespersonName}</h2>
                        <button onclick="navigate('Actual')" class="text-sm text-gray-500 hover:text-secondary transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Back to List
                        </button>
                    </div>

                    <form id="actual-plan-form" data-plan-id="${plan.id}" class="space-y-8">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm bg-gray-50 p-4 rounded-lg shadow-inner">
                            <div><strong>Branch:</strong> <span class="font-semibold text-secondary">${plan.branch}</span></div>
                            <div><strong>Plan From:</strong> <span class="font-semibold text-secondary">${new Date(plan.startDate.toMillis()).toLocaleDateString()}</span></div>
                            <div><strong>Plan To:</strong> <span class="font-semibold text-secondary">${new Date(plan.endDate.toMillis()).toLocaleDateString()}</span></div>
                            <div><strong>Status:</strong> <span class="font-semibold text-accent">${plan.status}</span></div>
                        </div>

                        <div class="space-y-4 border-b pb-6">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-semibold text-secondary">Customer Visit Actuals</h3>
                                <button type="button" id="add-customer-actual-btn" class="flex items-center text-sm font-medium text-primary hover:text-blue-700 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    Add New Customer
                                </button>
                            </div>
                            <div id="actual-customer-list" class="space-y-3">
                                ${plan.customers.map((c, index) => renderCustomerInput(c, index, true, true)).join('')}
                            </div>
                        </div>

                        <div class="space-y-4 border-b pb-6">
                            <h3 class="text-xl font-semibold text-secondary mb-4">Unit Actuals (Value in Rs.)</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 rounded-xl overflow-hidden shadow-md">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Target</th>
                                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actual</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="unit-actual-table-body">
                                        ${plan.unitActuals.map(ua => `
                                            <tr>
                                                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-secondary">${ua.unit}</td>
                                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${ua.target.toLocaleString('en-IN')}</td>
                                                <td class="px-4 py-2 whitespace-nowrap text-sm text-right">
                                                    <input type="number" min="0" data-unit="${ua.unit}" name="unit-actual" value="${ua.actual}" class="w-full p-1 border border-gray-300 rounded-md text-sm text-right actual-input focus:ring-primary focus:border-primary">
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="pt-6">
                            <button type="submit" class="w-full py-3 px-4 border border-transparent text-lg font-medium rounded-full text-white bg-primary hover:bg-blue-700 shadow-xl transition">
                                Save and Complete
                            </button>
                        </div>
                    </form>
                </div>
            `;
        };

        const renderActualModalContent = (plan) => {
            // Handle both Firestore Timestamp and string dates
            const getDateString = (dateValue) => {
                if (!dateValue) return 'N/A';
                try {
                    let date = null;
                    
                    console.log("Ã°Å¸â€œâ€¦ getDateString input:", dateValue, "Type:", typeof dateValue);
                    
                    // If it's a Firestore Timestamp object with toDate() method
                    if (dateValue && typeof dateValue === 'object' && typeof dateValue.toDate === 'function') {
                        console.log("  Ã¢â€ â€™ Converting from Timestamp.toDate()");
                        date = dateValue.toDate();
                    }
                    // If it's a Firestore Timestamp object with toMillis() method
                    else if (dateValue && typeof dateValue === 'object' && typeof dateValue.toMillis === 'function') {
                        console.log("  Ã¢â€ â€™ Converting from Timestamp.toMillis()");
                        date = new Date(dateValue.toMillis());
                    }
                    // If it's a plain object with _seconds (Firebase serialized timestamp)
                    else if (dateValue && typeof dateValue === 'object' && dateValue._seconds) {
                        console.log("  Ã¢â€ â€™ Converting from object._seconds:", dateValue._seconds);
                        date = new Date(dateValue._seconds * 1000);
                    }
                    // If it's a plain object with seconds (alternate Firebase format)
                    else if (dateValue && typeof dateValue === 'object' && dateValue.seconds) {
                        console.log("  Ã¢â€ â€™ Converting from object.seconds:", dateValue.seconds);
                        date = new Date(dateValue.seconds * 1000);
                    }
                    // If it's a string
                    else if (typeof dateValue === 'string') {
                        console.log("  Ã¢â€ â€™ Converting from string");
                        date = new Date(dateValue);
                    }
                    // If it's already a Date
                    else if (dateValue instanceof Date) {
                        console.log("  Ã¢â€ â€™ Already a Date object");
                        date = dateValue;
                    }
                    // If it's a number (milliseconds or seconds)
                    else if (typeof dateValue === 'number') {
                        console.log("  Ã¢â€ â€™ Converting from number (assuming milliseconds)");
                        date = new Date(dateValue);
                    }
                    
                    if (date && !isNaN(date.getTime())) {
                        const formatted = date.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        console.log("  Ã¢Å“â€¦ Formatted date:", formatted);
                        return formatted;
                    }
                    console.log("  Ã¢ÂÅ’ Could not create valid date");
                    return 'N/A';
                } catch (e) {
                    console.error("Error parsing date:", dateValue, e);
                    return 'N/A';
                }
            };

            // Ensure customers is properly parsed from JSON if it's a string
            let customers = plan.customers;
            if (typeof customers === 'string') {
                try {
                    customers = JSON.parse(customers);
                } catch (e) {
                    console.warn("Could not parse customers:", e);
                    customers = [];
                }
            }

            // Ensure unitActuals is properly parsed from JSON if it's a string
            let unitActuals = plan.unitActuals;
            if (typeof unitActuals === 'string') {
                try {
                    unitActuals = JSON.parse(unitActuals);
                } catch (e) {
                    console.warn("Could not parse unitActuals:", e);
                    unitActuals = plan.unitTargets ? plan.unitTargets.map(ut => ({ unit: ut.unit, target: ut.target, actual: 0 })) : [];
                }
            }

            return `
                <form id="actual-plan-modal-form" data-plan-id="${plan.id}" class="space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm bg-gray-50 p-4 rounded-lg">
                        <div><strong>Branch:</strong> <span class="font-semibold text-secondary">${plan.branch}</span></div>
                        <div><strong>Plan From:</strong> <span class="font-semibold text-secondary">${getDateString(plan.startDate)}</span></div>
                        <div><strong>Plan To:</strong> <span class="font-semibold text-secondary">${getDateString(plan.endDate)}</span></div>
                        <div><strong>Status:</strong> <span class="font-semibold text-accent">${plan.status}</span></div>
                    </div>

                    <div class="space-y-4 border-b pb-6">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-secondary">Customer Visit Actuals</h4>
                            <button type="button" id="add-customer-modal-btn" class="flex items-center text-sm font-medium text-primary hover:text-blue-700 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Add Customer
                            </button>
                        </div>
                        <div id="modal-actual-customer-list" class="space-y-3 max-h-40 overflow-y-auto">
                            ${customers.map((c, index) => renderCustomerInput(c, index, true, true)).join('')}
                        </div>
                    </div>

                    <div class="space-y-4 border-b pb-6">
                        <h4 class="text-lg font-semibold text-secondary">Unit Actuals (Value in Rs.)</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Unit</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Target (Editable for Admin)</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Actual</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="modal-unit-actual-table-body">
                                    ${unitActuals.map(ua => {
                                        const isEditableTarget = state.userProfile?.role === 'Master' || state.userProfile?.role === 'Branch Head';
                                        return `
                                        <tr>
                                            <td class="px-3 py-2 font-medium text-secondary">${ua.unit}</td>
                                            <td class="px-3 py-2 text-right">
                                                ${isEditableTarget ? `<input type="number" min="0" data-unit="${ua.unit}" name="unit-target" value="${ua.target}" class="w-full p-1 border border-gray-300 rounded text-sm text-right modal-target-input focus:ring-primary focus:border-primary">` : `<span class="text-gray-500">${ua.target.toLocaleString('en-IN')}</span>`}
                                            </td>
                                            <td class="px-3 py-2 text-right">
                                                <input type="number" min="0" data-unit="${ua.unit}" name="unit-actual" value="${ua.actual}" class="w-full p-1 border border-gray-300 rounded text-sm text-right modal-actual-input focus:ring-primary focus:border-primary">
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 bg-primary text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                            Save and Complete
                        </button>
                    </div>
                </form>
            `;
        };
        
        const handleActualSubmit = async (e) => {
            e.preventDefault();
            console.log("Ã°Å¸â€Â¥ handleActualSubmit TRIGGERED!");
            console.log("   Form ID:", e.target.id);
            console.log("   Form element:", e.target);
            
            // CRITICAL: Do NOT call render() here as it will close the modal!
            // We need to extract data while the modal is still open
            
            const form = e.target;
            const planId = form.getAttribute('data-plan-id');
            const isModal = form.id === 'actual-plan-modal-form';
            
            console.log("   Plan ID:", planId);
            console.log("   Is Modal:", isModal);
            
            try {
                // DEBUG: Log the actual HTML of the form to see what we're working with
                const formHTML = form.innerHTML;
                console.log("Ã°Å¸â€œâ€¹ FORM HTML (first 1000 chars):", formHTML.substring(0, 1000));
                
                // Check for disabled inputs which would prevent form submission
                const disabledInputs = form.querySelectorAll('[disabled]');
                console.log("Ã¢Å¡ Ã¯Â¸Â  Disabled inputs found:", disabledInputs.length);
                disabledInputs.forEach((input, idx) => {
                    console.log(`   Disabled ${idx}:`, input.name, "=", input.value, "tag:", input.tagName);
                });
                
                // 1. Extract Customer Actuals
                const customerRowsSelector = isModal ? '#modal-actual-customer-list .customer-row' : '#actual-customer-list .customer-row';
                const customerRows = document.querySelectorAll(customerRowsSelector);
                console.log("Ã°Å¸â€Â Looking for customer rows with selector:", customerRowsSelector);
                console.log("Found customer rows:", customerRows.length);
                
                // DEBUG: Log each customer row's HTML
                customerRows.forEach((row, idx) => {
                    console.log(`  Row ${idx} HTML (first 300 chars):`, row.innerHTML.substring(0, 300));
                });
                
                const actualCustomers = Array.from(customerRows).map(row => {
                    const nameInput = row.querySelector('[name="customer-name"]');
                    const statusSelect = row.querySelector('[name="visit-status"]');
                    const remarkTextarea = row.querySelector('[name="remark"]');

                    // DEBUG: Log the actual elements found
                    console.log("    Found nameInput:", nameInput ? "YES" : "NO");
                    if (nameInput) {
                        console.log("      nameInput.value =", nameInput.value, "| disabled =", nameInput.disabled, "| tagName =", nameInput.tagName);
                    }
                    console.log("    Found statusSelect:", statusSelect ? "YES" : "NO");
                    if (statusSelect) {
                        console.log("      statusSelect.value =", statusSelect.value, "| disabled =", statusSelect.disabled);
                    }
                    console.log("    Found remarkTextarea:", remarkTextarea ? "YES" : "NO");
                    if (remarkTextarea) {
                        console.log("      remarkTextarea.value =", remarkTextarea.value, "| disabled =", remarkTextarea.disabled);
                    }

                    const customerData = {
                        name: nameInput?.value || '',
                        visitStatus: statusSelect?.value || 'Pending',
                        remark: remarkTextarea?.value || '',
                        isNew: nameInput?.hasAttribute('data-is-new') ? (nameInput.getAttribute('data-is-new') === 'true') : false
                    };
                    console.log("  Ã¢Å“â€¦ Customer extracted:", JSON.stringify(customerData));
                    return customerData;
                }).filter(c => c.name.trim() !== '');  // CRITICAL: Only save customers that have at least a name entered

                console.log("Ã¢Å“â€¦ Total customers to save (with names):", actualCustomers.length, "| Full array:", JSON.stringify(actualCustomers));

                // Check if all planned customers have been accounted for (or check if at least one status is 'Visit Done' to mark as completed)
                const isPlanCompleted = actualCustomers.some(c => c.visitStatus === 'Visit Done' || c.visitStatus === 'Not Visit');
                
                // 2. Extract Unit Actuals and updated Targets
                const inputSelector = isModal ? '.modal-actual-input' : '.actual-input';
                const targetInputSelector = isModal ? '.modal-target-input' : '.target-input';
                const tableSelector = isModal ? '#modal-unit-actual-table-body' : '#unit-actual-table-body';
                const unitActualInputs = document.querySelectorAll(`${tableSelector} ${inputSelector}`);
                console.log("Ã°Å¸â€Â Looking for unit inputs with selector:", `${tableSelector} ${inputSelector}`);
                console.log("Found unit inputs:", unitActualInputs.length);
                
                // DEBUG: Log each unit input value
                unitActualInputs.forEach((input, idx) => {
                    console.log(`  Unit ${idx}: data-unit="${input.getAttribute('data-unit')}", value="${input.value}", type="${input.type}"`);
                });
                
                const unitActuals = Array.from(unitActualInputs).map(input => {
                    const unit = input.getAttribute('data-unit');
                    const targetInputElement = document.querySelector(`${tableSelector} [data-unit="${unit}"][name="unit-target"]`);
                    const targetValue = targetInputElement ? parseInt(targetInputElement.value) : (state.actualDetails.unitTargets.find(ut => ut.unit === unit)?.target || 0);
                    
                    const unitData = {
                        unit: unit,
                        target: targetValue,
                        actual: parseInt(input.value) || 0
                    };
                    console.log("  Unit extracted:", unitData);
                    return unitData;
                });

                console.log("Ã¢Å“â€¦ Total units to save:", unitActuals.length, unitActuals);
                
                // CRITICAL CHECK: Warn if saving with no customer data
                if (actualCustomers.length === 0 && !confirm("Ã¢Å¡ Ã¯Â¸Â  No customers with names entered! You are about to save ONLY unit actual values with NO customer visit data. \n\nPress OK to continue, or Cancel to go back and add customer names.")) {
                    console.warn("User cancelled save - no customer data");
                    state.loading = false;
                    render();
                    return;
                }
                
                // Log what we're about to save
                console.log("Ã°Å¸â€œÂ¤ ABOUT TO SAVE TO FIRESTORE:");
                console.log("   Customers JSON:", JSON.stringify(actualCustomers));
                console.log("   Unit Actuals JSON:", JSON.stringify(unitActuals));
                console.log("   Status: Completed");

                // 3. Update Firestore Document
                const updateData = {
                    customers: JSON.stringify(actualCustomers),
                    unitActuals: JSON.stringify(unitActuals),
                    updatedAt: firebase.firestore.Timestamp.now(),
                };

                // IMPORTANT: Always mark as 'Completed' when saving actuals
                // This ensures the plan moves to Completed status and is removed from Actual tab
                updateData.status = 'Completed';

                console.log("Ã°Å¸â€™Â¾ BEFORE Firestore update:");
                console.log("   updateData.customers:", updateData.customers);
                console.log("   updateData.unitActuals:", updateData.unitActuals);
                console.log("   updateData.status:", updateData.status);
                console.log("   planId:", planId);
                console.log("   FULL updateData object:", updateData);

                const docRef = db.collection(`artifacts/${appId}/public/data/plans`).doc(planId);
                console.log("Ã°Å¸â€œÂ Attempting Firestore update for planId:", planId);
                
                try {
                    await docRef.update(updateData);
                    console.log("Ã¢Å“â€¦ Firestore update completed successfully");
                } catch (firebaseError) {
                    console.error("Ã¢ÂÅ’ FIRESTORE UPDATE ERROR:");
                    console.error("   Error Code:", firebaseError.code);
                    console.error("   Error Message:", firebaseError.message);
                    console.error("   Full Error:", firebaseError);
                    
                    // Re-throw so main catch block handles it
                    throw firebaseError;
                }

                // Reset form element
                form.reset();

                // Clear state
                state.actualDetails = null;
                state.filteredPlans = []; // Clear filtered plans so they reload
                
                console.log("Ã¢Å“â€¦ Actual data saved to Firestore");
                console.log("Saved data - Customers:", JSON.stringify(actualCustomers));
                console.log("Saved data - Unit Actuals:", JSON.stringify(unitActuals));
                
                showModal('Success', 'Actuals saved successfully! Plan marked as <strong>Completed</strong> and will appear in Report tab. Data reflected on Dashboard.');
                
                // Wait for Firestore listener to update state.plans before navigating
                // The listener is real-time, but we give it a moment to receive the update
                setTimeout(() => {
                    console.log("Ã°Å¸â€œÅ  Current state.plans after waiting:", state.plans.length, "plans");
                    console.log("Ã°Å¸â€Â Plans with 'Completed' status:", state.plans.filter(p => p.status === 'Completed').length);
                    const completedPlan = state.plans.find(p => p.id === planId);
                    if (completedPlan) {
                        console.log("Ã¢Å“â€¦ Completed plan found:", completedPlan);
                        console.log("   Customers:", completedPlan.customers);
                        console.log("   Unit Actuals:", completedPlan.unitActuals);
                    } else {
                        console.log("Ã¢ÂÅ’ Completed plan NOT found in state.plans");
                    }
                    closeModal();
                    // Navigate to Report tab to see the completed plan with data
                    // By this time, the Firestore listener should have updated state.plans
                    navigate('Report');
                }, 2000);

            } catch (error) {
                console.error("Ã¢ÂÅ’ ACTUAL SUBMISSION FAILED:");
                console.error("   Error Message:", error.message);
                console.error("   Error Code:", error.code);
                console.error("   Full Error:", error);
                showModal('Error', `Actual submission failed: ${error.message}`);
                state.loading = false;
                render();
            }
        };

        window.deletePlan = async (planId) => {
            const confirmDelete = window.confirm('Are you sure you want to permanently delete this task?');
            if (!confirmDelete) return;

            state.loading = true;
            render();

            try {
                const docRef = db.collection(`artifacts/${appId}/public/data/plans`).doc(planId);
                await docRef.delete();
                showModal('Success', 'Task deleted successfully.');
            } catch (error) {
                console.error("Deletion failed:", error);
                showModal('Error', `Deletion failed: ${error.message}`);
            } finally {
                state.loading = false;
                // Data listener automatically updates state.plans and triggers a re-render
            }
        };


        // --- DASHBOARD UI & CHARTS ---
        
        const renderDashboard = () => {
            const userRole = state.userProfile.role;
            // Use filtered plans if available (when filters are applied), otherwise use all role-based plans
            const basePlans = state.filteredPlans || filterPlansByRole(state.plans);
            // Show metrics from ALL plans (both Planned and Completed) for real-time dashboard
            const allPlans = basePlans; // For all metrics
            const metrics = calculateMetrics(allPlans); // Use all plans for KPIs, not just completed
            const achievementValue = metrics.totalTarget > 0 ? Math.round((metrics.totalActual / metrics.totalTarget) * 100) : '0';
            const achievement = Math.min(achievementValue, 100); // Cap at 100%

            return `
                <div class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-secondary">Sales Dashboard</h2>
                    
                    ${userRole !== 'Sales Person' ? renderDashboardFilters() : ''}

                    <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-secondary">Display Format (for Total Target & Actual)</h3>
                            <select id="display-format-select" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary">
                                <option value="auto" ${state.displayFormat === 'auto' ? 'selected' : ''}>Auto (Auto-convert)</option>
                                <option value="k" ${state.displayFormat === 'k' ? 'selected' : ''}>K (Thousands)</option>
                                <option value="m" ${state.displayFormat === 'm' ? 'selected' : ''}>M (Millions)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                        ${renderKPICard('Total Target (Rs)', formatDisplayValue(metrics.totalTarget, state.displayFormat), 'text-primary', 'Ã¢â€šÂ¹')}
                        ${renderKPICard('Total Actual (Rs)', formatDisplayValue(metrics.totalActual, state.displayFormat), 'text-green-600', 'Ã¢â€šÂ¹')}
                        ${renderKPICard('Achievement (%)', achievement, achievement >= 100 ? 'text-green-600' : 'text-red-500', '%')}
                        ${renderKPICard('Active Sales Person', metrics.activeSalespersonsCount, 'text-blue-600')}
                        ${renderKPICard('Active Branches', metrics.activeBranchesCount, 'text-purple-600')}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${renderKPICard('Total Customers', metrics.totalCustomersCount, 'text-indigo-600')}
                        ${renderKPICard('Plan Activated', metrics.planActivatedCount, 'text-orange-600')}
                        ${renderKPICard('Actual Done', metrics.actualDoneCount, 'text-emerald-600')}
                        ${renderKPICard('Actual Pending', metrics.actualPendingCount, 'text-yellow-600')}
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg col-span-1">
                            <h3 class="text-lg font-semibold text-secondary mb-4">Visit Status Summary (Pie Chart)</h3>
                            <div class="h-80 flex items-center justify-center">
                                <canvas id="visit-status-chart" class="max-h-full max-w-full"></canvas>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg col-span-1 lg:col-span-2">
                            <h3 class="text-lg font-semibold text-secondary mb-4">Target Vs Actual By Unit (Column Chart)</h3>
                            <div class="h-80 flex items-center justify-center">
                                <canvas id="unit-column-chart" class="max-h-full max-w-full"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-secondary mb-4">Target vs Actual by Branch (Column Chart)</h3>
                            <div class="h-80 flex items-center justify-center">
                                <canvas id="branch-column-chart" class="max-h-full max-w-full"></canvas>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-secondary mb-4">Unit by Branch wise (Stacked Chart)</h3>
                            <div class="h-80 flex items-center justify-center">
                                <canvas id="branch-stacked-chart" class="max-h-full max-w-full"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderKPICard = (title, value, valueClass, unit = '') => `
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary">
                <p class="text-sm font-medium text-gray-500">${title}</p>
                <p class="mt-1 text-3xl font-bold ${valueClass}">
                    ${value}${unit === '%' ? '%' : ''}
                </p>
            </div>
        `;

        const renderDashboardFilters = () => {
            // Get unique employee names from all plans
            const allPlans = filterPlansByRole(state.plans);
            const employeeNames = [...new Set(allPlans.map(p => p.salespersonName))].sort();
            const userRole = state.userProfile?.role;
            const userBranch = state.userProfile?.branch;
            
            console.log("Ã°Å¸â€œâ€¹ Employee Names Available:", employeeNames);
            
            let filterOptions = [];
            if (userRole === 'Branch Head') {
                // Branch Head doesn't see branch filter (only their branch)
                filterOptions = [
                    { id: 'dash-employee', label: 'Employee Name', type: 'select', options: employeeNames },
                    { id: 'dash-month', label: 'Month', type: 'select', options: Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('en', { month: 'long' })) },
                    { id: 'dash-year', label: 'Year', type: 'select', options: ['2024', '2025', '2026'] },
                ];
            } else {
                // Master sees all filters
                filterOptions = [
                    { id: 'dash-employee', label: 'Employee Name', type: 'select', options: employeeNames },
                    { id: 'dash-branch', label: 'Branch', type: 'select', options: BRANCHES },
                    { id: 'dash-month', label: 'Month', type: 'select', options: Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('en', { month: 'long' })) },
                    { id: 'dash-year', label: 'Year', type: 'select', options: ['2024', '2025', '2026'] },
                ];
            }

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-secondary mb-4">Filters</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        ${filterOptions.map(f => {
                            let currentValue = '';
                            if (f.id === 'dash-employee') currentValue = state.filters.dashboard.employee;
                            else if (f.id === 'dash-branch') currentValue = state.filters.dashboard.branch;
                            else if (f.id === 'dash-month') currentValue = state.filters.dashboard.month;
                            else if (f.id === 'dash-year') currentValue = state.filters.dashboard.year;
                            
                            return `
                            <div class="min-w-0">
                                <label for="${f.id}" class="block text-xs font-medium text-gray-700 mb-1">
                                    ${f.label}
                                    ${currentValue ? `<span class="ml-1 text-primary font-bold">(${currentValue})</span>` : ''}
                                </label>
                                <select id="${f.id}" class="w-full px-3 py-2 border ${currentValue ? 'border-primary bg-blue-50' : 'border-gray-300'} rounded-lg text-sm focus:ring-primary focus:border-primary transition-colors" title="${f.label}">
                                    <option value="">All ${f.label}</option>
                                    ${f.options.map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        };
        
        // --- CHART INITIALIZATION ---
        const initCharts = () => {
            // Destroy any existing chart instances before re-rendering
            Object.values(state.charts).forEach(chart => chart.destroy());
            state.charts = {};

            const basePlans = state.filteredPlans && state.filteredPlans.length > 0 ? state.filteredPlans : filterPlansByRole(state.plans);
            
            // Show charts for all plans (both Planned and Completed) for better real-time visibility
            // Only filter out plans without actual data for meaningful chart display
            const plansWithData = basePlans.filter(p => 
                (p.unitActuals && p.unitActuals.length > 0) || 
                (p.unitTargets && p.unitTargets.length > 0)
            );
            
            if (plansWithData.length === 0) return;

            const metrics = calculateMetrics(plansWithData);

            // 1. Visit Status Pie Chart
            const pieCtx = document.getElementById('visit-status-chart');
            if (pieCtx) {
                const pieData = Object.values(metrics.visitStatusCounts);
                const pieLabels = Object.keys(metrics.visitStatusCounts);
                state.charts.visitStatus = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: pieLabels,
                        datasets: [{
                            data: pieData,
                            backgroundColor: ['#f59e0b', '#10a5e8', '#ef4444'], // Accent, Primary, Red
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: false,
                            }
                        }
                    }
                });
            }


            // 2. Target vs Actual Column Chart (By Unit)
            const columnCtx = document.getElementById('unit-column-chart');
            if (columnCtx) {
                const unitLabels = Object.keys(metrics.unitData);
                const targetData = unitLabels.map(u => metrics.unitData[u].target);
                const actualData = unitLabels.map(u => metrics.unitData[u].actual);

                state.charts.unitColumn = new Chart(columnCtx, {
                    type: 'bar',
                    data: {
                        labels: unitLabels,
                        datasets: [
                            {
                                label: 'Target (Rs)',
                                data: targetData,
                                backgroundColor: '#10a5e8', // Primary
                                barThickness: 20,
                            },
                            {
                                label: 'Actual (Rs)',
                                data: actualData,
                                backgroundColor: '#10b981', // Green
                                barThickness: 20,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: false,
                            },
                            y: {
                                stacked: false,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Value (Rs)'
                                }
                            }
                        }
                    }
                });
            }

            // 3. Target vs Actual by Branch (Column Chart)
            const branchColumnCtx = document.getElementById('branch-column-chart');
            if (branchColumnCtx) {
                const branchLabels = Object.keys(metrics.branchData).filter(b => metrics.branchData[b].target > 0 || metrics.branchData[b].actual > 0);
                const branchTargetData = branchLabels.map(b => metrics.branchData[b].target);
                const branchActualData = branchLabels.map(b => metrics.branchData[b].actual);

                state.charts.branchColumn = new Chart(branchColumnCtx, {
                    type: 'bar',
                    data: {
                        labels: branchLabels,
                        datasets: [
                            {
                                label: 'Target (Rs)',
                                data: branchTargetData,
                                backgroundColor: '#10a5e8', // Primary
                                barThickness: 20,
                            },
                            {
                                label: 'Actual (Rs)',
                                data: branchActualData,
                                backgroundColor: '#10b981', // Green
                                barThickness: 20,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: false,
                            },
                            y: {
                                stacked: false,
                                beginAtZero: true,
                            }
                        },
                        indexAxis: 'x'
                    }
                });
            }

            // 4. Unit by Branch wise (Stacked Bar Chart)
            const branchStackedCtx = document.getElementById('branch-stacked-chart');
            if (branchStackedCtx) {
                const branchLabels = Object.keys(metrics.branchData).filter(b => metrics.branchData[b].actual > 0);
                
                // Create datasets for each unit
                const unitColors = ['#10a5e8', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#6366f1'];
                const datasets = UNITS.map((unit, index) => ({
                    label: unit,
                    data: branchLabels.map(branch => {
                        const unitActual = plansWithData
                            .filter(p => p.branch === branch)
                            .flatMap(p => p.unitActuals)
                            .filter(ua => ua.unit === unit)
                            .reduce((sum, ua) => sum + ua.actual, 0);
                        return unitActual;
                    }),
                    backgroundColor: unitColors[index % unitColors.length],
                }));

                state.charts.branchStacked = new Chart(branchStackedCtx, {
                    type: 'bar',
                    data: {
                        labels: branchLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }
        };


        // --- REPORT UI & DOWNLOAD ---

        const renderReport = () => {
            console.log("Ã°Å¸â€œÅ  renderReport() called");
            console.log("   state.plans total:", state.plans ? state.plans.length : 0);
            console.log("   state.filteredPlans:", state.filteredPlans);
            
            const basePlans = state.filteredPlans || filterPlansByRole(state.plans);
            console.log("   basePlans count:", basePlans ? basePlans.length : 0);
            console.log("   basePlans:", basePlans);
            
            const completedTasks = basePlans.filter(p => p.status === 'Completed');
            console.log("   completedTasks count:", completedTasks.length);
            console.log("   completedTasks:", completedTasks);
            
            const userRole = state.userProfile.role;

            // Helper function to format dates
            const formatDate = (dateValue) => {
                if (!dateValue) return 'N/A';
                try {
                    let date = null;
                    if (dateValue && typeof dateValue.toDate === 'function') {
                        date = dateValue.toDate();
                    } else if (dateValue && typeof dateValue.toMillis === 'function') {
                        date = new Date(dateValue.toMillis());
                    } else if (dateValue && typeof dateValue === 'object' && dateValue._seconds) {
                        date = new Date(dateValue._seconds * 1000);
                    } else if (typeof dateValue === 'string') {
                        date = new Date(dateValue);
                    } else if (dateValue instanceof Date) {
                        date = dateValue;
                    }
                    
                    if (date && !isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    }
                    return 'N/A';
                } catch (e) {
                    console.error("Error formatting date:", dateValue, e);
                    return 'N/A';
                }
            };

            return `
                <div class="space-y-6">
                    ${renderReportFilters()}

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-extrabold text-secondary">Completed Reports (${completedTasks.length})</h2>
                        ${(userRole === 'Master' || userRole === 'Branch Head') ? `
                            <button id="download-report-csv" class="flex items-center bg-primary text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-700 transition shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Download CSV
                            </button>
                        ` : ''}
                    </div>

                    <div class="overflow-x-auto bg-white rounded-xl shadow-2xl">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Branch</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan Date (From-To)</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Target (Rs)</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Actual (Rs)</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Achievement (%)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${completedTasks.length > 0 ? completedTasks.map(plan => {
                                    // Parse unitTargets and unitActuals from JSON if needed
                                    let unitTargets = plan.unitTargets || [];
                                    if (typeof unitTargets === 'string') {
                                        try {
                                            unitTargets = JSON.parse(unitTargets);
                                        } catch (e) {
                                            console.warn("Could not parse unitTargets:", e);
                                            unitTargets = [];
                                        }
                                    }

                                    let unitActuals = plan.unitActuals || [];
                                    if (typeof unitActuals === 'string') {
                                        try {
                                            unitActuals = JSON.parse(unitActuals);
                                        } catch (e) {
                                            console.warn("Could not parse unitActuals:", e);
                                            unitActuals = [];
                                        }
                                    }

                                    let customers = plan.customers || [];
                                    if (typeof customers === 'string') {
                                        try {
                                            customers = JSON.parse(customers);
                                        } catch (e) {
                                            console.warn("Could not parse customers:", e);
                                            customers = [];
                                        }
                                    }

                                    const totalTarget = unitTargets.reduce((sum, ut) => sum + ut.target, 0);
                                    const totalActual = unitActuals.reduce((sum, ua) => sum + ua.actual, 0);
                                    const achievementValue = totalTarget > 0 ? Math.round((totalActual / totalTarget) * 100) : '0';
                                    const achievement = Math.min(achievementValue, 100); // Cap at 100%
                                    
                                    const visitDone = customers.filter(c => c.visitStatus === 'Visit Done').length;
                                    const visitNot = customers.filter(c => c.visitStatus === 'Not Visit').length;
                                    const visitSummary = customers.length > 0 ? `${visitDone} Done, ${visitNot} Not` : 'N/A';
                                    
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${plan.branch}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-secondary">${plan.salespersonName}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                ${formatDate(plan.startDate)} - ${formatDate(plan.endDate)}
                                            </td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${totalTarget.toLocaleString('en-IN')}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${totalActual.toLocaleString('en-IN')}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-semibold ${achievement >= 100 ? 'text-green-600' : 'text-red-600'}">${achievement}%</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${visitSummary}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm space-x-2">
                                                <button onclick="viewReportDetails('${plan.id}')" class="text-primary hover:text-blue-700 font-medium">
                                                    View Details
                                                </button>
                                                ${userRole === 'Master' || userRole === 'Branch Head' ? `
                                                    <button onclick="editActualFromReport('${plan.id}')" class="text-blue-600 hover:text-blue-900 font-medium">
                                                        Edit Actual
                                                    </button>
                                                ` : ''}
                                                ${userRole === 'Master' ? `
                                                    <button onclick="deleteReportRow('${plan.id}')" class="text-red-600 hover:text-red-900 font-medium">
                                                        Delete
                                                    </button>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `;
                                }).join('') : `
                                    <tr>
                                        <td colspan="${userRole === 'Master' ? '5' : '4'}" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                                            No completed reports found for your access level.
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const renderReportFilters = () => {
            // Get unique employee names from all plans
            const allPlans = filterPlansByRole(state.plans);
            const employeeNames = [...new Set(allPlans.map(p => p.salespersonName))].sort();
            const userRole = state.userProfile?.role;
            const userBranch = state.userProfile?.branch;
            
            // For Sales Person role, hide employee and branch filters (they only see their own data)
            let filterOptions = [];
            if (userRole === 'Sales Person') {
                // Sales Person only sees month, year, and visit status filters
                filterOptions = [
                    { id: 'rep-month', label: 'Month', type: 'select', options: Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('en', { month: 'long' })) },
                    { id: 'rep-year', label: 'Year', type: 'select', options: ['2024', '2025', '2026'] },
                    { id: 'rep-visit-status', label: 'Visit Status', type: 'select', options: ['Visit Done', 'Not Visit', 'Pending'] },
                ];
            } else if (userRole === 'Branch Head') {
                // Branch Head only sees their own branch + employee, month, year, visit status filters (no branch filter)
                filterOptions = [
                    { id: 'rep-employee', label: 'Employee Name', type: 'select', options: employeeNames },
                    { id: 'rep-month', label: 'Month', type: 'select', options: Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('en', { month: 'long' })) },
                    { id: 'rep-year', label: 'Year', type: 'select', options: ['2024', '2025', '2026'] },
                    { id: 'rep-visit-status', label: 'Visit Status', type: 'select', options: ['Visit Done', 'Not Visit', 'Pending'] },
                ];
            } else {
                // Master sees all filters
                filterOptions = [
                    { id: 'rep-employee', label: 'Employee Name', type: 'select', options: employeeNames },
                    { id: 'rep-branch', label: 'Branch', type: 'select', options: BRANCHES },
                    { id: 'rep-month', label: 'Month', type: 'select', options: Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('en', { month: 'long' })) },
                    { id: 'rep-year', label: 'Year', type: 'select', options: ['2024', '2025', '2026'] },
                    { id: 'rep-visit-status', label: 'Visit Status', type: 'select', options: ['Visit Done', 'Not Visit', 'Pending'] },
                ];
            }

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-secondary mb-4">Filters</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        ${filterOptions.map(f => {
                            let currentValue = '';
                            if (f.id === 'rep-employee') currentValue = state.filters.report.employee;
                            else if (f.id === 'rep-branch') currentValue = state.filters.report.branch;
                            else if (f.id === 'rep-month') currentValue = state.filters.report.month;
                            else if (f.id === 'rep-year') currentValue = state.filters.report.year;
                            else if (f.id === 'rep-visit-status') currentValue = state.filters.report.visitStatus;
                            
                            return `
                            <div class="min-w-0">
                                <label for="${f.id}" class="block text-xs font-medium text-gray-700 mb-1">${f.label}</label>
                                <select id="${f.id}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary">
                                    <option value="">All ${f.label}</option>
                                    ${f.options.map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                            `;
                        }).join('')}
                        <div class="col-span-2 md:col-span-1 lg:col-span-1 flex items-end">
                            <button id="rep-search-btn" class="w-full bg-primary text-white py-2 rounded-lg text-sm hover:bg-blue-700 transition">Search</button>
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.viewReportDetails = (planId) => {
            const plan = state.plans.find(p => p.id === planId);
            if (plan && plan.status === 'Completed') {
                showModal('Report Details', renderReportDetailsContent(plan));
            }
        };

        const renderReportDetailsContent = (plan) => {
            console.log("Ã°Å¸â€œâ€¹ Rendering Report Details for plan:", plan.id);
            console.log("   Raw plan data:", plan);
            
            // Helper function to parse dates
            const formatDate = (dateValue) => {
                if (!dateValue) return 'N/A';
                try {
                    let date = null;
                    if (dateValue && typeof dateValue.toDate === 'function') {
                        date = dateValue.toDate();
                    } else if (dateValue && typeof dateValue.toMillis === 'function') {
                        date = new Date(dateValue.toMillis());
                    } else if (dateValue && typeof dateValue === 'object' && dateValue._seconds) {
                        date = new Date(dateValue._seconds * 1000);
                    } else if (typeof dateValue === 'string') {
                        date = new Date(dateValue);
                    } else if (dateValue instanceof Date) {
                        date = dateValue;
                    }
                    
                    if (date && !isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    }
                    return 'N/A';
                } catch (e) {
                    console.error("Error formatting date:", dateValue, e);
                    return 'N/A';
                }
            };

            // Parse customers from JSON if needed
            let customers = plan.customers || [];
            console.log("   Raw customers:", customers, "Type:", typeof customers);
            if (typeof customers === 'string') {
                try {
                    customers = JSON.parse(customers);
                    console.log("   Parsed customers:", customers);
                } catch (e) {
                    console.warn("Could not parse customers:", e);
                    customers = [];
                }
            }

            // Parse unitActuals from JSON if needed
            let unitActuals = plan.unitActuals || [];
            console.log("   Raw unitActuals:", unitActuals, "Type:", typeof unitActuals);
            if (typeof unitActuals === 'string') {
                try {
                    unitActuals = JSON.parse(unitActuals);
                    console.log("   Parsed unitActuals:", unitActuals);
                } catch (e) {
                    console.warn("Could not parse unitActuals:", e);
                    unitActuals = [];
                }
            }

            // Parse unitTargets from JSON if needed
            let unitTargets = plan.unitTargets || [];
            console.log("   Raw unitTargets:", unitTargets, "Type:", typeof unitTargets);
            if (typeof unitTargets === 'string') {
                try {
                    unitTargets = JSON.parse(unitTargets);
                    console.log("   Parsed unitTargets:", unitTargets);
                } catch (e) {
                    console.warn("Could not parse unitTargets:", e);
                    unitTargets = [];
                }
            }

            const totalTarget = unitTargets.reduce((sum, ut) => sum + ut.target, 0);
            const totalActual = unitActuals.reduce((sum, ua) => sum + ua.actual, 0);
            const achievementValue = totalTarget > 0 ? Math.round((totalActual / totalTarget) * 100) : '0';
            const achievement = Math.min(achievementValue, 100); // Cap at 100%
            const userRole = state.userProfile.role;

            const customerRows = customers.map((c, index) => {
                const statusClass = c.visitStatus === 'Visit Done' ? 'text-green-600 font-semibold' : c.visitStatus === 'Not Visit' ? 'text-red-600 font-semibold' : 'text-yellow-600 font-semibold';
                return `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-secondary">${c.name} ${c.isNew ? '<span class="text-xs text-yellow-600 ml-1">(New)</span>' : ''}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-center ${statusClass}">${c.visitStatus}</td>
                        <td class="px-4 py-2 whitespace-normal text-sm text-gray-700 max-w-xs">${c.remark || 'No remark provided.'}</td>
                        ${userRole === 'Master' ? `
                            <td class="px-4 py-2 whitespace-nowrap text-sm">
                                <button onclick="deleteCustomerFromReport('${plan.id}', '${c.name}')" class="text-red-600 hover:text-red-900 font-medium text-xs">
                                    Delete
                                </button>
                            </td>
                        ` : ''}
                    </tr>
                `;
            }).join('');

            const unitRows = unitActuals.map(ua => {
                const unitTarget = unitTargets.find(ut => ut.unit === ua.unit)?.target || 0;
                const unitAchievementValue = unitTarget > 0 ? Math.round((ua.actual / unitTarget) * 100) : '0';
                const unitAchievement = Math.min(unitAchievementValue, 100); // Cap at 100%
                return `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-secondary">${ua.unit}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${unitTarget.toLocaleString('en-IN')}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-primary text-right">${ua.actual.toLocaleString('en-IN')}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-semibold ${unitAchievement >= 100 ? 'text-green-600' : 'text-red-600'} text-right">${unitAchievement}%</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="space-y-6">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-extrabold text-primary">Sales Report Details</h3>
                        <p class="text-lg text-secondary">${plan.salespersonName} - ${plan.branch}</p>
                        <p class="text-sm text-gray-500">${formatDate(plan.startDate)} to ${formatDate(plan.endDate)}</p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p><strong>Total Target:</strong> <span class="text-secondary font-semibold">${totalTarget.toLocaleString('en-IN')} Rs</span></p>
                        <p><strong>Total Actual:</strong> <span class="text-primary font-semibold">${totalActual.toLocaleString('en-IN')} Rs</span></p>
                        <p><strong>Total Achievement:</strong> <span class="${achievement >= 100 ? 'text-green-600' : 'text-red-600'} font-semibold">${achievement}%</span></p>
                        <p><strong>Status:</strong> <span class="text-green-600 font-semibold">${plan.status}</span></p>
                    </div>

                    <h4 class="text-xl font-semibold text-secondary mt-6 border-b pb-2">Unit Performance</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Target (Rs)</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actual (Rs)</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Achieved (%)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${unitRows.length > 0 ? unitRows : '<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">No unit data available.</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <h4 class="text-xl font-semibold text-secondary mt-6 border-b pb-2">Customer Visit Details</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sr. No</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remark</th>
                                    ${userRole === 'Master' ? `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>` : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${customerRows.length > 0 ? customerRows : `<tr><td colspan="${userRole === 'Master' ? '5' : '4'}" class="px-4 py-2 text-center text-gray-500">No customer data available.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        // Download PLANNING Report for Actual tab (Planning data only - customers & targets)
        window.downloadPlanningVsActualCSV = () => {
            // Apply current filters to get filtered plans
            let filteredPlans = filterPlansByRole(state.plans);
            
            // Apply Actual tab specific filters
            if (state.filters.actual.employee) {
                filteredPlans = filteredPlans.filter(p => p.salespersonName === state.filters.actual.employee);
            }
            if (state.filters.actual.branch && state.userProfile?.role === 'Master') {
                filteredPlans = filteredPlans.filter(p => p.branch === state.filters.actual.branch);
            }
            if (state.filters.actual.month) {
                filteredPlans = filteredPlans.filter(p => {
                    const planMonth = new Date(p.startDate.toMillis ? p.startDate.toMillis() : p.startDate).toLocaleString('en', { month: 'long' });
                    return planMonth === state.filters.actual.month;
                });
            }
            if (state.filters.actual.year) {
                filteredPlans = filteredPlans.filter(p => {
                    const planYear = new Date(p.startDate.toMillis ? p.startDate.toMillis() : p.startDate).getFullYear().toString();
                    return planYear === state.filters.actual.year;
                });
            }

            if (filteredPlans.length === 0) {
                showModal('Download Failed', 'No plans found with applied filters.');
                return;
            }

            // Get current month for sheet naming
            const currentMonth = new Date().toLocaleString('en', { month: 'long' });
            
            // SHEET 1: Customer Planning Data (Customer names only - no visit status/remarks yet)
            const customerSheet = [];
            customerSheet.push(['ID', 'Sales Person Name', 'Branch', 'Start Date', 'End Date', 'Customer Name']);
            
            // SHEET 2: Target Plan (targets only - no actuals in Actual tab report)
            const targetSheet = [];
            targetSheet.push(['ID', 'Sales Person Name', 'Branch', 'Start Date', 'End Date', 'Unit', 'Target']);
            
            // Process each filtered plan
            filteredPlans.forEach(plan => {
                let unitTargets = plan.unitTargets || [];
                if (typeof unitTargets === 'string') {
                    try { unitTargets = JSON.parse(unitTargets); } catch (e) { unitTargets = []; }
                }
                
                let customers = plan.customers || [];
                if (typeof customers === 'string') {
                    try { customers = JSON.parse(customers); } catch (e) { customers = []; }
                }
                
                const startDateStr = new Date(plan.startDate.toMillis ? plan.startDate.toMillis() : plan.startDate).toLocaleDateString('en-IN');
                const endDateStr = new Date(plan.endDate.toMillis ? plan.endDate.toMillis() : plan.endDate).toLocaleDateString('en-IN');
                
                // Add customer data to Sheet 1 (just customer names - planning stage)
                if (customers.length === 0) {
                    customerSheet.push([plan.id, plan.salespersonName, plan.branch, startDateStr, endDateStr, '']);
                } else {
                    customers.forEach(customer => {
                        customerSheet.push([
                            plan.id,
                            plan.salespersonName,
                            plan.branch,
                            startDateStr,
                            endDateStr,
                            customer.name || ''
                        ]);
                    });
                }
                
                // Add unit data to Sheet 2 (targets only - no actuals)
                UNITS.forEach(unit => {
                    const ut = unitTargets.find(u => u.unit === unit);
                    targetSheet.push([
                        plan.id,
                        plan.salespersonName,
                        plan.branch,
                        startDateStr,
                        endDateStr,
                        unit,
                        ut ? ut.target : 0
                    ]);
                });
            });
            
            // Helper function to convert array to CSV with proper escaping
            const convertToCSV = (data) => {
                return data.map(row => 
                    row.map(cell => {
                        const cellStr = String(cell || '');
                        return cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n') 
                            ? `"${cellStr.replace(/"/g, '""')}"` 
                            : cellStr;
                    }).join(',')
                ).join('\n');
            };
            
            // Create two CSV sections for both sheets
            const sheet1CSV = convertToCSV(customerSheet);
            const sheet2CSV = convertToCSV(targetSheet);
            
            // Combine both sheets with clear separation for CSV format
            const fullContent = `Planning Report - ${currentMonth}\n${sheet1CSV}\n\n\nTarget Plan - ${currentMonth}\n${sheet2CSV}`;
            
            // Create and download as CSV file
            const blob = new Blob([fullContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `Planning_Report_${currentMonth}_${new Date().toISOString().slice(0, 10)}.csv`);
            
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
            
            showModal('Success', `Ã¢Å“â€¦ Planning Report downloaded as CSV!\\n\\nSheet 1: Customer Planning List\\nSheet 2: Target Plan\\n\\nFilters Applied: ${state.filters.actual.employee || 'All Employees'}, ${state.filters.actual.month || 'All Months'}, ${state.filters.actual.year || 'All Years'}`);
        };

        // Save only the remark without completing the plan
        window.saveCustomerRemark = async (index) => {
            if (!state.actualDetails) return;
            
            try {
                const customerRow = document.querySelector(`.customer-row[data-index="${index}"]`);
                if (!customerRow) return;
                
                const nameInput = customerRow.querySelector('[name="customer-name"]');
                const statusSelect = customerRow.querySelector('[name="visit-status"]');
                const remarkTextarea = customerRow.querySelector('[name="remark"]');
                
                if (!nameInput || !statusSelect || !remarkTextarea) return;
                
                // Update the customer in state
                if (state.actualDetails.customers[index]) {
                    state.actualDetails.customers[index].name = nameInput.value;
                    state.actualDetails.customers[index].visitStatus = statusSelect.value;
                    state.actualDetails.customers[index].remark = remarkTextarea.value;
                }
                
                // Save to Firestore - update only customers, don't mark as Completed
                const planId = state.actualDetails.id;
                const docRef = db.collection(`artifacts/${appId}/public/data/plans`).doc(planId);
                
                await docRef.update({
                    customers: JSON.stringify(state.actualDetails.customers),
                    updatedAt: firebase.firestore.Timestamp.now()
                });
                
                showModal('Success', 'Customer remark saved successfully! Plan remains in Pending state.');
            } catch (error) {
                console.error("Error saving remark:", error);
                showModal('Error', `Failed to save remark: ${error.message}`);
            }
        };

        window.downloadCSVReport = () => {
            const reportsToDownload = filterPlansByRole(state.plans).filter(p => p.status === 'Completed');

            if (reportsToDownload.length === 0) {
                showModal('Download Failed', 'No completed reports found to download.');
                return;
            }

            // Flatten the nested data structure for CSV
            const flatData = reportsToDownload.map(plan => {
                const totalTarget = plan.unitTargets.reduce((sum, ut) => sum + ut.target, 0);
                const totalActual = plan.unitActuals.reduce((sum, ua) => sum + ua.actual, 0);
                const achievementValue = totalTarget > 0 ? Math.round((totalActual / totalTarget) * 100) : '0';
                const achievement = Math.min(achievementValue, 100); // Cap at 100%

                const baseData = {
                    id: plan.id,
                    salespersonName: plan.salespersonName,
                    branch: plan.branch,
                    startDate: plan.startDate,
                    endDate: plan.endDate,
                    status: plan.status,
                    totalTarget: totalTarget,
                    totalActual: totalActual,
                    achievement: achievement + '%',
                };

                // Add Unit-wise Targets and Actuals
                UNITS.forEach(unit => {
                    const ut = plan.unitTargets.find(t => t.unit === unit);
                    const ua = plan.unitActuals.find(a => a.unit === unit);
                    baseData[`${unit}_Target`] = ut ? ut.target : 0;
                    baseData[`${unit}_Actual`] = ua ? ua.actual : 0;
                });
                
                // Add Customer data (simplistic way, listing all customers and status in one field)
                baseData.customerVisits = plan.customers.map(c => `${c.name} (${c.visitStatus})`).join('; ');
                
                return baseData;
            });

            const csvContent = generateCSV(flatData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `Sales_Report_${new Date().toISOString().slice(0, 10)}.csv`);
            
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        };

        // --- MODAL UI ---
        const renderModal = () => {
            if (!state.modal.isOpen) return '';
            
            return `
                <div class="fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle ${state.modal.isForm ? 'sm:max-w-4xl' : 'sm:max-w-lg'} sm:w-full max-h-screen overflow-y-auto">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="flex justify-between items-start mb-4">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        ${state.modal.title}
                                    </h3>
                                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <div class="mt-2">
                                    ${state.modal.isForm ? state.modal.content : `<p class="text-sm text-gray-500">${state.modal.content}</p>`}
                                </div>
                            </div>
                            ${state.modal.isForm ? '' : `
                                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                    <button onclick="closeModal()" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm transition">
                                        Close
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        };

        // --- MAIN APP UI & NAVIGATION ---

        const renderMainApp = () => {
            const { fullName, role, branch } = state.userProfile;
            return `
                ${renderHeader(fullName, role, branch)}
                <div class="p-4 sm:p-6 lg:p-8">
                    ${renderTabs()}
                    <div class="mt-6">
                        ${renderPageContent()}
                    </div>
                </div>
                ${renderModal()}
            `;
        };

        const renderHeader = (fullName, role, branch) => `
            <header class="bg-white shadow-md sticky top-0 z-10">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                    <div class="flex items-center">
                        <img class="h-10 w-auto rounded-lg" src="${COMPANY_LOGO_URL}" alt="${COMPANY_NAME}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/10a5e8/ffffff?text=G';">
                        <h1 class="ml-3 text-xl font-bold text-secondary hidden sm:block">${COMPANY_NAME}</h1>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium text-secondary">
                            ${fullName} (<span class="text-primary">${role}</span>)
                        </p>
                        <p class="text-xs text-gray-500">${branch} | User ID: ${state.userId.substring(0, 8)}...</p>
                        <button id="logout-button" class="mt-1 text-xs text-red-500 hover:text-red-700 transition">
                            Sign Out
                        </button>
                    </div>
                </div>
            </header>
        `;

        const renderTabs = () => {
            let tabs = ['Dashboard', 'NewPlan', 'Actual', 'Report'];

            return `
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4 sm:space-x-8 px-4 sm:px-0" aria-label="Tabs">
                        ${tabs.map(tab => {
                            const isActive = state.currentPage === tab;
                            const baseClasses = "whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition duration-150 ease-in-out";
                            const activeClasses = "border-primary text-primary";
                            const inactiveClasses = "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300";

                            return `
                                <button data-page="${tab}" class="${baseClasses} ${isActive ? activeClasses : inactiveClasses}" onclick="navigate('${tab}')">
                                    ${tab.replace('NewPlan', 'New Plan')}
                                </button>
                            `;
                        }).join('')}
                    </nav>
                </div>
            `;
        };

        // --- REPORT MANAGEMENT ---

        window.editActualFromReport = async (planId) => {
            try {
                const plansRef = db.collection(`artifacts/${appId}/public/data/plans`);
                const planDoc = await plansRef.doc(planId).get();
                
                if (!planDoc.exists) {
                    showModal('Error', 'Plan not found.');
                    return;
                }
                
                const plan = {
                    id: planId,
                    ...planDoc.data()
                };
                
                // Change status back to 'Planned' so it appears in Actual tab for editing
                await plansRef.doc(planId).update({ status: 'Planned' });
                
                // Directly set state.actualDetails with the fetched plan data
                // This ensures all customer data (name, visitStatus, remark) is loaded
                state.actualDetails = {
                    id: planId,
                    ...plan
                };
                
                // Parse JSON strings if needed
                if (typeof state.actualDetails.customers === 'string') {
                    try {
                        state.actualDetails.customers = JSON.parse(state.actualDetails.customers);
                    } catch (e) {
                        console.warn("Could not parse customers:", e);
                        state.actualDetails.customers = [];
                    }
                }
                
                if (typeof state.actualDetails.unitTargets === 'string') {
                    try {
                        state.actualDetails.unitTargets = JSON.parse(state.actualDetails.unitTargets);
                    } catch (e) {
                        console.warn("Could not parse unitTargets:", e);
                        state.actualDetails.unitTargets = [];
                    }
                }
                
                if (typeof state.actualDetails.unitActuals === 'string') {
                    try {
                        state.actualDetails.unitActuals = JSON.parse(state.actualDetails.unitActuals);
                    } catch (e) {
                        console.warn("Could not parse unitActuals:", e);
                        state.actualDetails.unitActuals = [];
                    }
                }
                
                // Navigate to Actual tab to show it in Pending Actualization list
                navigate('Actual');
                
                // Wait a moment for render to complete, then open the modal form
                setTimeout(() => {
                    openActualModalForm(planId);
                }, 500);
                
            } catch (error) {
                console.error("Error loading plan for editing:", error);
                showModal('Error', `Could not load plan: ${error.message}`);
            }
        };
        
        window.deleteReportRow = async (planId) => {
            const confirmDelete = window.confirm('Are you sure you want to delete this report? This action cannot be undone.');
            if (!confirmDelete) return;

            state.loading = true;
            render();

            try {
                const plansRef = db.collection(`artifacts/${appId}/public/data/plans`);
                await plansRef.doc(planId).delete();

                showModal('Success', 'Report deleted successfully.');
                // Plans will auto-update via listener
            } catch (error) {
                console.error("Report deletion failed:", error);
                showModal('Error', `Report deletion failed: ${error.message}`);
            } finally {
                state.loading = false;
                render();
            }
        };

        window.deleteCustomerFromReport = async (planId, customerName) => {
            const confirmDelete = window.confirm(`Delete customer "${customerName}" from this report?`);
            if (!confirmDelete) return;

            state.loading = true;

            try {
                const plansRef = db.collection(`artifacts/${appId}/public/data/plans`);
                const planDoc = await plansRef.doc(planId).get();
                
                if (planDoc.exists) {
                    const planData = planDoc.data();
                    // Parse customers if stored as JSON string
                    let customers = planData.customers;
                    if (typeof customers === 'string') {
                        customers = JSON.parse(customers);
                    }
                    // Remove customer from customers array
                    const updatedCustomers = customers.filter(c => c.name !== customerName);
                    
                    await plansRef.doc(planId).update({
                        customers: JSON.stringify(updatedCustomers)
                    });

                    showModal('Success', `Customer "${customerName}" removed from report.`);
                    // Plans will auto-update via listener
                } else {
                    showModal('Error', 'Report not found.');
                }
            } catch (error) {
                console.error("Customer deletion failed:", error);
                showModal('Error', `Failed to remove customer: ${error.message}`);
            } finally {
                state.loading = false;
                render();
            }
        };



        const renderPageContent = () => {
            switch (state.currentPage) {
                case 'Dashboard':
                    return renderDashboard();
                case 'NewPlan':
                    return renderNewPlanForm();
                case 'Actual':
                    return renderActualList();
                case 'Report':
                    return renderReport();
                default:
                    return `<div class="p-6 text-center text-gray-500">Select a tab.</div>`;
            }
        };

        // --- EVENT LISTENERS ATTACHMENT ---
        const attachEventListeners = () => {
            // Auth Screen Listeners
            document.getElementById('toggle-auth-mode')?.addEventListener('click', () => {
                state.currentPage = state.currentPage === 'Login' ? 'Register' : 'Login';
                render();
            });
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', handleRegister);
            document.getElementById('logout-button')?.addEventListener('click', handleLogout);

            // Tab Navigation Listeners
            document.querySelectorAll('[data-page]').forEach(tabBtn => {
                tabBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.target.getAttribute('data-page');
                    if (page) navigate(page);
                });
            });

            // Password visibility toggles for register form
            document.getElementById('reg-password-toggle')?.addEventListener('click', (e) => {
                e.preventDefault();
                const input = document.getElementById('reg-password');
                input.type = input.type === 'password' ? 'text' : 'password';
            });
            document.getElementById('reg-confirm-password-toggle')?.addEventListener('click', (e) => {
                e.preventDefault();
                const input = document.getElementById('reg-confirm-password');
                input.type = input.type === 'password' ? 'text' : 'password';
            });

            // Role selection for branch visibility in register
            document.getElementById('reg-role')?.addEventListener('change', (e) => {
                const branchContainer = document.getElementById('branch-select-container');
                const branchSelect = document.getElementById('reg-branch');
                if (e.target.value === 'Master') {
                    branchContainer.style.display = 'none';
                    branchSelect.removeAttribute('required');
                } else {
                    branchContainer.style.display = 'block';
                    branchSelect.setAttribute('required', 'required');
                }
            });

            // Display Format Listener
            document.getElementById('display-format-select')?.addEventListener('change', (e) => {
                state.displayFormat = e.target.value;
                render();
            });

            // New Plan Listeners
            document.getElementById('new-plan-form')?.addEventListener('submit', handlePlanSubmit);
            document.getElementById('add-customer-plan-btn')?.addEventListener('click', () => addCustomerRow(false));

            // Actual Form Listeners (for non-modal form)
            document.getElementById('actual-plan-form')?.addEventListener('submit', handleActualSubmit);
            document.getElementById('add-customer-actual-btn')?.addEventListener('click', () => addCustomerRow(true));

            // Actual Modal Form Listeners - Use event delegation since modal form only exists when modal is open
            // Listen on document for form submissions and delegate to handler based on form ID
            if (!window.actualFormListenerAttached) {
                document.addEventListener('submit', (e) => {
                    if (e.target.id === 'actual-plan-modal-form' || e.target.id === 'actual-plan-form') {
                        handleActualSubmit(e);
                    }
                }, true); // Use capture phase to catch the event
                window.actualFormListenerAttached = true;
                console.log("Ã¢Å“â€¦ Actual form submit listener attached (using event delegation)");
            }
            
            document.getElementById('add-customer-modal-btn')?.addEventListener('click', () => addCustomerRow(true));
            
            // Report Listener
            document.getElementById('download-report-csv')?.addEventListener('click', downloadCSVReport);
            document.getElementById('download-planning-actual-csv')?.addEventListener('click', downloadPlanningVsActualCSV);

            // Dashboard Filter Listeners - apply on change
            document.getElementById('dash-employee')?.addEventListener('change', applyDashboardFilters);
            document.getElementById('dash-branch')?.addEventListener('change', applyDashboardFilters);
            document.getElementById('dash-month')?.addEventListener('change', applyDashboardFilters);
            document.getElementById('dash-year')?.addEventListener('change', applyDashboardFilters);
            
            // Actual Filter Listeners - apply on change
            document.getElementById('act-employee')?.addEventListener('change', applyActualFilters);
            document.getElementById('act-branch')?.addEventListener('change', applyActualFilters);
            document.getElementById('act-month')?.addEventListener('change', applyActualFilters);
            document.getElementById('act-year')?.addEventListener('change', applyActualFilters);
            document.getElementById('act-search-btn')?.addEventListener('click', applyActualFilters);
            
            // Clear filters button
            document.getElementById('clear-filters-btn')?.addEventListener('click', () => {
                state.filters.actual = { employee: '', branch: '', month: '', year: '' };
                state.filteredPlans = []; // Clear filters to show all plans
                render();
            });
            
            // Report Filter Listeners - apply on change
            document.getElementById('rep-employee')?.addEventListener('change', applyReportFilters);
            document.getElementById('rep-branch')?.addEventListener('change', applyReportFilters);
            document.getElementById('rep-month')?.addEventListener('change', applyReportFilters);
            document.getElementById('rep-year')?.addEventListener('change', applyReportFilters);
            document.getElementById('rep-visit-status')?.addEventListener('change', applyReportFilters);
            document.getElementById('rep-search-btn')?.addEventListener('click', applyReportFilters);
            document.getElementById('rep-visit-status')?.addEventListener('change', applyReportFilters);
            document.getElementById('rep-search-btn')?.addEventListener('click', applyReportFilters);

            // Chart Initialization (must be called after DOM is rendered)
            if (state.currentPage === 'Dashboard') {
                initCharts();
            }
        };
        
        // --- APPLICATION START ---
        initFirebase();
    </script>
</body>
</html>
